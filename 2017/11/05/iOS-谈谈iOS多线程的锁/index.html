<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*è¿›åº¦æ¡é¢œè‰²*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*é˜´å½±é¢œè‰²*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*ä¸Šè¾¹æ¡†é¢œè‰²*/
        border-left-color: #1E92FB;    /*å·¦è¾¹æ¡†é¢œè‰²*/
    }
</style>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="å–µæ¸£æ¸£ã®åèŠ±å›­" type="application/atom+xml" />






<meta name="description" content="å‰è¨€iOSå¼€å‘ä¸­ç”±äºå„ç§ç¬¬ä¸‰æ–¹åº“çš„é«˜åº¦å°è£…ï¼Œå¯¹é”çš„ä½¿ç”¨å¾ˆå°‘ï¼Œåˆšå¥½ä¹‹å‰é¢è¯•ä¸­è¢«é—®åˆ°çš„å…³äºå¹¶å‘ç¼–ç¨‹é”çš„é—®é¢˜ï¼Œéƒ½æ˜¯ä¸€çŸ¥åŠè§£ï¼Œäºæ˜¯å†³å®šæ•´ç†ä¸€ä¸‹å…³äºiOSä¸­é”çš„çŸ¥è¯†ï¼Œä¸ºå¤§å®¶æŸ¥ç¼ºè¡¥æ¼ã€‚ ç›®å½•ç¬¬ä¸€éƒ¨åˆ†ï¼š ä»€ä¹ˆæ˜¯é”ç¬¬äºŒéƒ¨åˆ†ï¼š é”çš„åˆ†ç±»ç¬¬ä¸‰éƒ¨åˆ†ï¼š æ€§èƒ½å¯¹æ¯”ç¬¬å››éƒ¨åˆ†ï¼š å¸¸è§çš„æ­»é”ç¬¬äº”éƒ¨åˆ†ï¼š æ€»ç»“æ­£æ–‡ä¸€ã€ä»€ä¹ˆæ˜¯é”åœ¨è¿‡å»å‡ åå¹´å¹¶å‘ç ”ç©¶é¢†åŸŸçš„å‡ºç‰ˆç‰©ä¸­ï¼Œé”æ€»æ˜¯æ‰®æ¼”ç€åäººçš„è§’è‰²ï¼Œé”èƒŒè´Ÿçš„æŒ‡æ§åŒ…æ‹¬å¼•èµ·æ­»é”ã€é”å°æŠ¤ï¼ˆluyang">
<meta property="og:type" content="article">
<meta property="og:title" content="[iOS] è°ˆè°ˆiOSå¤šçº¿ç¨‹çš„é” ">
<meta property="og:url" content="http://yoursite.com/2017/11/05/iOS-è°ˆè°ˆiOSå¤šçº¿ç¨‹çš„é”/index.html">
<meta property="og:site_name" content="å–µæ¸£æ¸£ã®åèŠ±å›­">
<meta property="og:description" content="å‰è¨€iOSå¼€å‘ä¸­ç”±äºå„ç§ç¬¬ä¸‰æ–¹åº“çš„é«˜åº¦å°è£…ï¼Œå¯¹é”çš„ä½¿ç”¨å¾ˆå°‘ï¼Œåˆšå¥½ä¹‹å‰é¢è¯•ä¸­è¢«é—®åˆ°çš„å…³äºå¹¶å‘ç¼–ç¨‹é”çš„é—®é¢˜ï¼Œéƒ½æ˜¯ä¸€çŸ¥åŠè§£ï¼Œäºæ˜¯å†³å®šæ•´ç†ä¸€ä¸‹å…³äºiOSä¸­é”çš„çŸ¥è¯†ï¼Œä¸ºå¤§å®¶æŸ¥ç¼ºè¡¥æ¼ã€‚ ç›®å½•ç¬¬ä¸€éƒ¨åˆ†ï¼š ä»€ä¹ˆæ˜¯é”ç¬¬äºŒéƒ¨åˆ†ï¼š é”çš„åˆ†ç±»ç¬¬ä¸‰éƒ¨åˆ†ï¼š æ€§èƒ½å¯¹æ¯”ç¬¬å››éƒ¨åˆ†ï¼š å¸¸è§çš„æ­»é”ç¬¬äº”éƒ¨åˆ†ï¼š æ€»ç»“æ­£æ–‡ä¸€ã€ä»€ä¹ˆæ˜¯é”åœ¨è¿‡å»å‡ åå¹´å¹¶å‘ç ”ç©¶é¢†åŸŸçš„å‡ºç‰ˆç‰©ä¸­ï¼Œé”æ€»æ˜¯æ‰®æ¼”ç€åäººçš„è§’è‰²ï¼Œé”èƒŒè´Ÿçš„æŒ‡æ§åŒ…æ‹¬å¼•èµ·æ­»é”ã€é”å°æŠ¤ï¼ˆluyang">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/3178216-d9ca6f03933b11db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://img.blog.csdn.net/20150726170216381">
<meta property="og:image" content="http://cc.cocimg.com/api/uploads/20160129/1454031867325687.png">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1024259-9363902b817ceba0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1024259-80b7739e80b2bb52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://blog.ibireme.com/wp-content/uploads/2016/01/lock_benchmark.png">
<meta property="og:image" content="http://ww3.sinaimg.cn/mw690/0064cTs2jw1ewev3nwkpzj30sg0l3412.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/mw690/0064cTs2jw1ewev3oimsbj30sg0p30we.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/mw690/0064cTs2jw1ewev3p5j6pj30sg0iggpc.jpg">
<meta property="og:image" content="http://ww4.sinaimg.cn/mw690/0064cTs2jw1ewev3pjumnj30sg0mgwir.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/mw690/0064cTs2jw1ewev3q5d5ej30sg0jl0w1.jpg">
<meta property="og:updated_time" content="2017-11-05T13:40:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[iOS] è°ˆè°ˆiOSå¤šçº¿ç¨‹çš„é” ">
<meta name="twitter:description" content="å‰è¨€iOSå¼€å‘ä¸­ç”±äºå„ç§ç¬¬ä¸‰æ–¹åº“çš„é«˜åº¦å°è£…ï¼Œå¯¹é”çš„ä½¿ç”¨å¾ˆå°‘ï¼Œåˆšå¥½ä¹‹å‰é¢è¯•ä¸­è¢«é—®åˆ°çš„å…³äºå¹¶å‘ç¼–ç¨‹é”çš„é—®é¢˜ï¼Œéƒ½æ˜¯ä¸€çŸ¥åŠè§£ï¼Œäºæ˜¯å†³å®šæ•´ç†ä¸€ä¸‹å…³äºiOSä¸­é”çš„çŸ¥è¯†ï¼Œä¸ºå¤§å®¶æŸ¥ç¼ºè¡¥æ¼ã€‚ ç›®å½•ç¬¬ä¸€éƒ¨åˆ†ï¼š ä»€ä¹ˆæ˜¯é”ç¬¬äºŒéƒ¨åˆ†ï¼š é”çš„åˆ†ç±»ç¬¬ä¸‰éƒ¨åˆ†ï¼š æ€§èƒ½å¯¹æ¯”ç¬¬å››éƒ¨åˆ†ï¼š å¸¸è§çš„æ­»é”ç¬¬äº”éƒ¨åˆ†ï¼š æ€»ç»“æ­£æ–‡ä¸€ã€ä»€ä¹ˆæ˜¯é”åœ¨è¿‡å»å‡ åå¹´å¹¶å‘ç ”ç©¶é¢†åŸŸçš„å‡ºç‰ˆç‰©ä¸­ï¼Œé”æ€»æ˜¯æ‰®æ¼”ç€åäººçš„è§’è‰²ï¼Œé”èƒŒè´Ÿçš„æŒ‡æ§åŒ…æ‹¬å¼•èµ·æ­»é”ã€é”å°æŠ¤ï¼ˆluyang">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/3178216-d9ca6f03933b11db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/11/05/iOS-è°ˆè°ˆiOSå¤šçº¿ç¨‹çš„é”/"/>





  <title>[iOS] è°ˆè°ˆiOSå¤šçº¿ç¨‹çš„é”  | å–µæ¸£æ¸£ã®åèŠ±å›­</title>
  








  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<!-- é¡µé¢ç‚¹å‡»å°çº¢å¿ƒ -->
<script type="text/javascript" src="/js/src/love.js"></script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/sumlunmao" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">å–µæ¸£æ¸£ã®åèŠ±å›­</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">å–„å­¦è€…å°½å…¶ç†ï¼Œå–„è¡Œè€…ç©¶å…¶éš¾</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/05/iOS-è°ˆè°ˆiOSå¤šçº¿ç¨‹çš„é”/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ed Sum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="å–µæ¸£æ¸£ã®åèŠ±å›­">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[iOS] è°ˆè°ˆiOSå¤šçº¿ç¨‹çš„é” </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">VerÃ¶ffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-05T20:59:27+08:00">
                2017-11-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  7,645
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  30
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://upload-images.jianshu.io/upload_images/3178216-d9ca6f03933b11db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="äº”èŠ±å…«é—¨çš„é”"></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>iOSå¼€å‘ä¸­ç”±äºå„ç§ç¬¬ä¸‰æ–¹åº“çš„é«˜åº¦å°è£…ï¼Œå¯¹é”çš„ä½¿ç”¨å¾ˆå°‘ï¼Œåˆšå¥½ä¹‹å‰é¢è¯•ä¸­è¢«é—®åˆ°çš„å…³äºå¹¶å‘ç¼–ç¨‹é”çš„é—®é¢˜ï¼Œéƒ½æ˜¯ä¸€çŸ¥åŠè§£ï¼Œäºæ˜¯å†³å®šæ•´ç†ä¸€ä¸‹å…³äºiOSä¸­é”çš„çŸ¥è¯†ï¼Œä¸ºå¤§å®¶æŸ¥ç¼ºè¡¥æ¼ã€‚</p>
<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><h3 id="ç¬¬ä¸€éƒ¨åˆ†ï¼š-ä»€ä¹ˆæ˜¯é”"><a href="#ç¬¬ä¸€éƒ¨åˆ†ï¼š-ä»€ä¹ˆæ˜¯é”" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†ï¼š ä»€ä¹ˆæ˜¯é”"></a>ç¬¬ä¸€éƒ¨åˆ†ï¼š ä»€ä¹ˆæ˜¯é”</h3><h3 id="ç¬¬äºŒéƒ¨åˆ†ï¼š-é”çš„åˆ†ç±»"><a href="#ç¬¬äºŒéƒ¨åˆ†ï¼š-é”çš„åˆ†ç±»" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†ï¼š é”çš„åˆ†ç±»"></a>ç¬¬äºŒéƒ¨åˆ†ï¼š é”çš„åˆ†ç±»</h3><h3 id="ç¬¬ä¸‰éƒ¨åˆ†ï¼š-æ€§èƒ½å¯¹æ¯”"><a href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼š-æ€§èƒ½å¯¹æ¯”" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†ï¼š æ€§èƒ½å¯¹æ¯”"></a>ç¬¬ä¸‰éƒ¨åˆ†ï¼š æ€§èƒ½å¯¹æ¯”</h3><h3 id="ç¬¬å››éƒ¨åˆ†ï¼š-å¸¸è§çš„æ­»é”"><a href="#ç¬¬å››éƒ¨åˆ†ï¼š-å¸¸è§çš„æ­»é”" class="headerlink" title="ç¬¬å››éƒ¨åˆ†ï¼š å¸¸è§çš„æ­»é”"></a>ç¬¬å››éƒ¨åˆ†ï¼š å¸¸è§çš„æ­»é”</h3><h3 id="ç¬¬äº”éƒ¨åˆ†ï¼š-æ€»ç»“"><a href="#ç¬¬äº”éƒ¨åˆ†ï¼š-æ€»ç»“" class="headerlink" title="ç¬¬äº”éƒ¨åˆ†ï¼š æ€»ç»“"></a>ç¬¬äº”éƒ¨åˆ†ï¼š æ€»ç»“</h3><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><h3 id="ä¸€ã€ä»€ä¹ˆæ˜¯é”"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯é”" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯é”"></a>ä¸€ã€ä»€ä¹ˆæ˜¯é”</h3><p>åœ¨è¿‡å»å‡ åå¹´å¹¶å‘ç ”ç©¶é¢†åŸŸçš„å‡ºç‰ˆç‰©ä¸­ï¼Œé”æ€»æ˜¯æ‰®æ¼”ç€åäººçš„è§’è‰²ï¼Œé”èƒŒè´Ÿçš„æŒ‡æ§åŒ…æ‹¬å¼•èµ·æ­»é”ã€é”å°æŠ¤ï¼ˆluyangæ³¨ï¼šlock convoyingï¼Œå¤šä¸ªåŒä¼˜å…ˆçº§çš„çº¿ç¨‹é‡å¤ç«äº‰åŒä¸€æŠŠé”ï¼Œæ­¤æ—¶å¤§é‡è™½ç„¶è¢«å”¤é†’è€Œå¾—ä¸åˆ°é”çš„çº¿ç¨‹è¢«è¿«è¿›è¡Œè°ƒåº¦åˆ‡æ¢ï¼Œè¿™ç§é¢‘ç¹çš„è°ƒåº¦åˆ‡æ¢ç›¸å½“å½±å“ç³»ç»Ÿæ€§èƒ½ï¼‰ã€é¥¥é¥¿ã€ä¸å…¬å¹³ã€data racesä»¥åŠå…¶ä»–è®¸å¤šå¹¶å‘å¸¦æ¥çš„ç½ªå­½ã€‚æœ‰è¶£çš„æ˜¯ï¼Œåœ¨å…±äº«å†…å­˜å¹¶è¡Œè½¯ä»¶ä¸­çœŸæ­£æ‰¿æ‹…é‡æ‹…çš„æ˜¯â€”â€”ä½ çŒœå¯¹äº†â€”â€”é”ã€‚</p>
<p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œé”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯¹èµ„æºè®¿é—®çš„é™åˆ¶ã€‚ä½ å¯ä»¥ç†è§£æˆå®ƒç”¨äºæ’é™¤å¹¶å‘çš„ä¸€ç§ç­–ç•¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (lock == 0) &#123;</div><div class="line">lock = myPID;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™æ®µä»£ç å¹¶ä¸èƒ½ä¿è¯è¿™ä¸ªä»»åŠ¡æœ‰é”ï¼Œå› æ­¤å®ƒå¯ä»¥åœ¨åŒä¸€æ—¶é—´è¢«å¤šä¸ªä»»åŠ¡æ‰§è¡Œã€‚è¿™ä¸ªæ—¶å€™å°±æœ‰å¯èƒ½å¤šä¸ªä»»åŠ¡éƒ½æ£€æµ‹åˆ°lockæ˜¯ç©ºé—²çš„ï¼Œå› æ­¤ä¸¤ä¸ªæˆ–è€…å¤šä¸ªä»»åŠ¡éƒ½å°†å°è¯•è®¾ç½®lockï¼Œè€Œä¸çŸ¥é“å…¶ä»–çš„ä»»åŠ¡ä¹Ÿåœ¨å°è¯•è®¾ç½®lockã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºé—®é¢˜äº†ã€‚å†çœ‹çœ‹ä¸‹é¢è¿™æ®µä»£ç (Swift)ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">class Account &#123;</div><div class="line">private(set) var val: Int = 0 //è¿™é‡Œä¸å¯åœ¨å…¶ä»–æ–¹æ³•ä¿®æ”¹ï¼Œåªèƒ½é€šè¿‡add/minusä¿®æ”¹</div><div class="line">public func add(x: Int) &#123;</div><div class="line">objc_sync_exit(self)</div><div class="line">defer &#123;</div><div class="line">objc_sync_exit(self)</div><div class="line">&#125;</div><div class="line">val += x</div><div class="line">&#125;</div><div class="line"></div><div class="line">public func minus(x: Int) &#123;</div><div class="line">objc_sync_exit(self)</div><div class="line">defer &#123;</div><div class="line">objc_sync_exit(self)</div><div class="line">&#125;</div><div class="line">val -= x;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±èƒ½é˜²æ­¢å¤šä¸ªä»»åŠ¡å»ä¿®æ”¹valäº†ã€‚</p>
<h3 id="äºŒã€é”çš„åˆ†ç±»"><a href="#äºŒã€é”çš„åˆ†ç±»" class="headerlink" title="äºŒã€é”çš„åˆ†ç±»"></a>äºŒã€é”çš„åˆ†ç±»</h3><p>é”æ ¹æ®ä¸åŒçš„æ€§è´¨å¯ä»¥åˆ†æˆä¸åŒçš„ç±»ã€‚</p>
<p>åœ¨WiKiPediaä»‹ç»ä¸­ï¼Œä¸€èˆ¬çš„é”éƒ½æ˜¯å»ºè®®é”ï¼Œä¹Ÿå°±å››æ¯ä¸ªä»»åŠ¡å»è®¿é—®å…¬å…±èµ„æºçš„æ—¶å€™ï¼Œéƒ½éœ€è¦å–å¾—é”çš„èµ„è®¯ï¼Œå†æ ¹æ®é”èµ„è®¯æ¥ç¡®å®šæ˜¯å¦å¯ä»¥å­˜å–ã€‚è‹¥å­˜å–å¯¹åº”èµ„è®¯ï¼Œé”çš„çŠ¶æ€ä¼šæ”¹å˜ä¸ºé”å®šï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹ä¸ä¼šè®¿é—®è¯¥èµ„æºï¼Œå½“ç»“æŸè®¿é—®æ—¶ï¼Œé”ä¼šé‡Šæ”¾ï¼Œå…è®¸å…¶ä»–ä»»åŠ¡è®¿é—®ã€‚æœ‰äº›ç³»ç»Ÿæœ‰å¼ºåˆ¶é”ï¼Œè‹¥æœªç»æˆæƒçš„é”è®¿é—®é”å®šçš„èµ„æ–™ï¼Œåœ¨è®¿é—®æ—¶å°±ä¼šäº§ç”Ÿå¼‚å¸¸ã€‚</p>
<p>åœ¨iOSä¸­ï¼Œé”åˆ†ä¸ºäº’æ–¥é”ã€é€’å½’é”ã€ä¿¡å·é‡ã€æ¡ä»¶é”ã€è‡ªæ—‹é”ã€è¯»å†™é”ï¼ˆä¸€ç§ç‰¹æ‰€çš„è‡ªæ—‹é”ï¼‰ã€åˆ†å¸ƒå¼é”ã€‚</p>
<p>å¯¹äºæ•°æ®åº“çš„é”åˆ†ç±»ï¼š</p>
<table>
<thead>
<tr>
<th>åˆ†ç±»æ–¹å¼</th>
<th>åˆ†ç±»</th>
</tr>
</thead>
<tbody>
<tr>
<td>æŒ‰é”çš„ç²’åº¦åˆ’åˆ†</td>
<td>è¡¨çº§é”ã€è¡Œçº§é”ã€é¡µçº§é”</td>
</tr>
<tr>
<td>æŒ‰é”çš„çº§åˆ«åˆ’åˆ†</td>
<td>å…±äº«é”ã€æ’ä»–é”</td>
</tr>
<tr>
<td>æŒ‰åŠ é”çš„æ–¹å¼åˆ’åˆ†</td>
<td>è‡ªåŠ¨é”ã€æ˜¾ç¤ºé”</td>
</tr>
<tr>
<td>æŒ‰é”çš„ä½¿ç”¨æ–¹å¼åˆ’åˆ†</td>
<td>ä¹è§‚é”ã€æ‚²è§‚é”</td>
</tr>
<tr>
<td>æŒ‰æ“ä½œåˆ’åˆ†</td>
<td>DMLé”ã€DDLé”</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œå°±ä¸å†è¯¦ç»†çš„ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£çš„å¤§å®¶å¯ä»¥å¸¦<a href="https://www.wikipedia.org" target="_blank" rel="external">Wiki</a><br>æŸ¥é˜…<a href="http://www.yankay.com/å¹¶å‘ç¼–ç¨‹ä¹‹å·§ç”¨é”/" target="_blank" rel="external">ç›¸å…³èµ„æ–™</a>ã€‚</p>
<h4 id="1ã€äº’æ–¥é”"><a href="#1ã€äº’æ–¥é”" class="headerlink" title="1ã€äº’æ–¥é”"></a>1ã€äº’æ–¥é”</h4><blockquote>
<p>åœ¨ç¼–ç¨‹ä¸­ï¼Œå¼•å…¥å¯¹è±¡äº’æ–¥é”çš„æ¦‚å¿µï¼Œæ¥ä¿è¯å…±äº«æ•°æ®æ“ä½œçš„å®Œæ•´æ€§ã€‚æ¯ä¸ªå¯¹è±¡éƒ½å¯¹åº”äºä¸€ä¸ªå¯ç§°ä¸ºâ€œäº’æ–¥é”â€çš„æ ‡è®°ï¼Œè¿™ä¸ªæ ‡è®°ç”¨æ¥ä¿è¯åœ¨ä»»ä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¯¹è±¡ã€‚</p>
</blockquote>
<p><strong>1.1 @synchronized</strong></p>
<ul>
<li>@synchronizedè¦ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ç›¸å½“äºä¿¡å·é‡</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// ç”¨åœ¨é˜²æ­¢å¤šçº¿ç¨‹è®¿é—®å±æ€§ä¸Šæ¯”è¾ƒå¤š</div><div class="line">- (void)setTestInt:(NSInteger *)testInt &#123;</div><div class="line">@ synchronized (self) &#123;</div><div class="line">_testInt = testInt;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>1.2 NSLock</strong></p>
<ul>
<li>blockåŠå®å®šä¹‰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// å®šä¹‰blockç±»å‹</div><div class="line">typedef void(^MMBlock)(void);</div><div class="line"></div><div class="line">// å®šä¹‰è·å–å…¨å±€é˜Ÿåˆ—æ–¹æ³•</div><div class="line">#define MM_GLOBAL_QUEUE(block) \</div><div class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123; \</div><div class="line">while (1) &#123; \</div><div class="line">block();\</div><div class="line">&#125;\</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<ul>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSLock *lock = [[NSLock alloc] init];</div><div class="line">MMBlock block = ^&#123;</div><div class="line">[lock lock];</div><div class="line">NSLog(@&quot;æ‰§è¡Œæ“ä½œ&quot;);</div><div class="line">sleep(1);</div><div class="line">[lock unlock];</div><div class="line">&#125;;</div><div class="line">MM_GLOBAL_QUEUE(block);</div></pre></td></tr></table></figure>
<p><strong>1.3 pthread</strong></p>
<blockquote>
<p>pthreadé™¤äº†åˆ›å»ºäº’æ–¥é”ï¼Œè¿˜å¯ä»¥åˆ›å»ºé€’å½’é”ã€è¯»å†™é”ã€onceç­‰é”ã€‚ç¨åä¼šä»‹ç»ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ã€‚å¦‚æœæƒ³è¦æ·±å…¥å­¦ä¹ pthreadè¯·æŸ¥é˜…ç›¸å…³æ–‡æ¡£ã€èµ„æ–™å•ç‹¬å­¦ä¹ ã€‚</p>
</blockquote>
<ul>
<li><p>é™æ€åˆå§‹åŒ–ï¼š <code>pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER</code></p>
</li>
<li><p>åŠ¨æ€åˆå§‹åŒ–ï¼š <code>pthread_mutex_init()</code> å‡½æ•°æ˜¯ä»¥åŠ¨æ€æ–¹å¼åˆ›å»ºäº’æ–¥é”çš„ï¼Œå‚æ•° <strong>attr</strong> æŒ‡å®šäº†æ–°å»ºäº’æ–¥é”çš„å±æ€§ã€‚å¦‚æœå‚æ•° <strong>attr</strong> ä¸º <strong>NULL</strong> ,ä½¿ç”¨é»˜è®¤çš„å±æ€§ï¼Œè¿”å›0ä»£è¡¨åˆå§‹åŒ–æˆåŠŸã€‚è¿™ç§æ–¹å¼å¯ä»¥åˆå§‹åŒ–æ™®é€šé”ã€é€’å½’é”(åŒ <strong> NSRecursiveLock</strong> ), åˆå§‹åŒ–æ–¹å¼æœ‰äº›å¤æ‚ã€‚</p>
</li>
<li><p>æ­¤ç±»åˆå§‹åŒ–æ–¹æ³•å¯è®¾ç½®é”çš„ç±»å‹ï¼Œ<code>PTHREAD_MUTEX_ERRORCHECK</code> äº’æ–¥é”ä¸ä¼šæ£€æµ‹æ­»é”ï¼Œ <code>PTHREAD_MUTEX_ERRORCHECK</code> äº’æ–¥é”å¯æä¾›é”™è¯¯æ£€æŸ¥ï¼Œ <code>PTHREAD_MUTEX_RECURSIVE</code> é€’å½’é”ï¼Œ <code>PTHREAD_PROCESS_DEFAULT</code> æ˜ å°„åˆ° <code>PTHREAD_PROCESS_NORMAL</code>.</p>
</li>
<li><p>ä¸‹é¢æ˜¯æˆ‘ä»<a href="https://github.com/ibireme/YYKit" target="_blank" rel="external">YYKit</a>copyä¸‹æ¥çš„ï¼š</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">#import &lt;pthread.h&gt;</div><div class="line"></div><div class="line">//YYKit</div><div class="line">static inline void pthread_mutex_init_recursive(pthread_mutex_t *mutex, bool recursive) &#123;</div><div class="line">#define YYMUTEX_ASSERT_ON_ERROR(x_) do &#123; \</div><div class="line">__unused volatile int res = (x_); \</div><div class="line">assert(res == 0); \</div><div class="line">&#125; while (0)</div><div class="line">assert(mutex != NULL);</div><div class="line">if (!recursive) &#123;</div><div class="line">//æ™®é€šé”</div><div class="line">YYMUTEX_ASSERT_ON_ERROR(pthread_mutex_init(mutex, NULL));</div><div class="line">&#125; else &#123;</div><div class="line">//é€’å½’é”</div><div class="line">pthread_mutexattr_t attr;</div><div class="line">YYMUTEX_ASSERT_ON_ERROR(pthread_mutexattr_init (&amp;attr));</div><div class="line">YYMUTEX_ASSERT_ON_ERROR(pthread_mutexattr_settype (&amp;attr, PTHREAD_MUTEX_RECURSIVE));</div><div class="line">YYMUTEX_ASSERT_ON_ERROR(pthread_mutex_init (mutex, &amp;attr));</div><div class="line">YYMUTEX_ASSERT_ON_ERROR(pthread_mutexattr_destroy (&amp;attr));</div><div class="line">&#125;</div><div class="line">#undef YYMUTEX_ASSERT_ON_ERROR</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">__block pthread_mutex_t lock;</div><div class="line">pthread_mutex_init_recursive(&amp;lock,false);</div><div class="line"></div><div class="line">MMBlock block0=^&#123;</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 0ï¼šåŠ é”&quot;);</div><div class="line">pthread_mutex_lock(&amp;lock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 0ï¼šç¡çœ  1 ç§’&quot;);</div><div class="line">sleep(1);</div><div class="line">pthread_mutex_unlock(&amp;lock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 0ï¼šè§£é”&quot;);</div><div class="line">&#125;;</div><div class="line">MM_GLOBAL_QUEUE(block0);</div><div class="line"></div><div class="line">MMBlock block1=^()&#123;</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 1ï¼šåŠ é”&quot;);</div><div class="line">pthread_mutex_lock(&amp;lock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 1ï¼šç¡çœ  2 ç§’&quot;);</div><div class="line">sleep(2);</div><div class="line">pthread_mutex_unlock(&amp;lock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 1ï¼šè§£é”&quot;);</div><div class="line">&#125;;</div><div class="line">MM_GLOBAL_QUEUE(block1);</div><div class="line"></div><div class="line">MMBlock block2=^&#123;</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 2ï¼šåŠ é”&quot;);</div><div class="line">pthread_mutex_lock(&amp;lock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 2ï¼šç¡çœ  3 ç§’&quot;);</div><div class="line">sleep(3);</div><div class="line">pthread_mutex_unlock(&amp;lock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 2ï¼šè§£é”&quot;);</div><div class="line">&#125;;</div><div class="line">MM_GLOBAL_QUEUE(block2);</div></pre></td></tr></table></figure>
<ul>
<li>è¾“å‡ºç»“æœï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">çº¿ç¨‹ 2ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 0ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 1ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 2ï¼šç¡çœ  3 ç§’</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">çº¿ç¨‹ 2ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 0ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 1ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 2ï¼šç¡çœ  3 ç§’</div><div class="line">çº¿ç¨‹ 2ï¼šè§£é”</div><div class="line">çº¿ç¨‹ 0ï¼šç¡çœ  1 ç§’</div><div class="line">çº¿ç¨‹ 2ï¼šåŠ é”</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">çº¿ç¨‹ 2ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 0ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 1ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 2ï¼šç¡çœ  3 ç§’</div><div class="line">çº¿ç¨‹ 2ï¼šè§£é”</div><div class="line">çº¿ç¨‹ 0ï¼šç¡çœ  1 ç§’</div><div class="line">çº¿ç¨‹ 2ï¼šåŠ é”</div><div class="line">çº¿ç¨‹ 0ï¼šè§£é”</div><div class="line">çº¿ç¨‹ 1ï¼šç¡çœ  2 ç§’</div><div class="line">çº¿ç¨‹ 0ï¼šåŠ é”</div></pre></td></tr></table></figure>
<h4 id="2ã€é€’å½’é”"><a href="#2ã€é€’å½’é”" class="headerlink" title="2ã€é€’å½’é”"></a>2ã€é€’å½’é”</h4><blockquote>
<p>åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡åŠ é”ï¼Œä¸ä¼šé€ æˆæ­»é”</p>
</blockquote>
<p>ä¸¾ä¸ªğŸŒ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">NSLock *lock = [[NSLock alloc] init];</div><div class="line"></div><div class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line"></div><div class="line">static void (^RecursiveMethod)(int);</div><div class="line"></div><div class="line">RecursiveMethod = ^(int value) &#123;</div><div class="line"></div><div class="line">[lock lock];</div><div class="line">if (value &gt; 0) &#123;</div><div class="line"></div><div class="line">NSLog(@&quot;value = %d&quot;, value);</div><div class="line">sleep(2);</div><div class="line">RecursiveMethod(value - 1);</div><div class="line">&#125;</div><div class="line">[lock unlock];</div><div class="line">&#125;;</div><div class="line"></div><div class="line">RecursiveMethod(5);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªå…¸å‹çš„æ­»é”æƒ…å†µã€‚åœ¨æˆ‘ä»¬çš„çº¿ç¨‹ä¸­ï¼ŒRecursiveMethodæ˜¯é€’å½’è°ƒç”¨çš„ã€‚æ‰€æœ‰æ¯æ¬¡è¿›å…¥è¿™ä¸ªblockæ—¶ï¼Œéƒ½ä¼šå»åŠ ä¸€æ¬¡é”ï¼Œè€Œä»ç¬¬äºŒæ¬¡å¼€å§‹ï¼Œç”±äºé”å·²ç»è¢«ä½¿ç”¨äº†ä¸”æ²¡æœ‰è§£é”ï¼Œæ‰€æœ‰å®ƒéœ€è¦ç­‰å¾…é”è¢«è§£é™¤ï¼Œè¿™æ ·å°±å¯¼è‡´äº†æ­»é”ï¼Œçº¿ç¨‹è¢«é˜»å¡ä½äº†ã€‚æ§åˆ¶å°ä¼šè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">value = 5</div><div class="line">*** -[NSLock lock]: deadlock ( &apos;(null)&apos;)   *** Break on _NSLockError() to debug.</div></pre></td></tr></table></figure>
<p><strong>2.1 NSRecursiveLock</strong></p>
<ul>
<li>å®ç°ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">NSRecursiveLock *lock = [[NSRecursiveLock alloc] init];</div><div class="line">MM_GLOBAL_QUEUE(^&#123;</div><div class="line">static void (^RecursiveBlock)(int);</div><div class="line">RecursiveBlock = ^(int value) &#123;</div><div class="line">[lock lock];</div><div class="line">if (value &gt; 0) &#123;</div><div class="line">NSLog(@&quot;åŠ é”å±‚æ•° %d&quot;, value);</div><div class="line">sleep(1);</div><div class="line">RecursiveBlock(--value);</div><div class="line">&#125;</div><div class="line">[lock unlock];</div><div class="line">&#125;;</div><div class="line">RecursiveBlock(3);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>è¾“å‡ºç»“æœ(ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºå¹¶æœªå‘ç”Ÿæ­»é”)ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">åŠ é”å±‚æ•° 3</div><div class="line">åŠ é”å±‚æ•° 2</div><div class="line">åŠ é”å±‚æ•° 1</div><div class="line">åŠ é”å±‚æ•° 3</div><div class="line">åŠ é”å±‚æ•° 2</div><div class="line">åŠ é”å±‚æ•° 1</div><div class="line">åŠ é”å±‚æ•° 3</div><div class="line">åŠ é”å±‚æ•° 2</div></pre></td></tr></table></figure>
<p><strong>2.2 pthread</strong></p>
<ul>
<li>ä»£ç å®ç°</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">__block pthread_mutex_t lock;</div><div class="line">//ç¬¬äºŒä¸ªå‚æ•°ä¸ºtrueç”Ÿæˆé€’å½’é”</div><div class="line">pthread_mutex_init_recursive(&amp;lock,true);</div><div class="line"></div><div class="line">MM_GLOBAL_QUEUE(^&#123;</div><div class="line">static void (^RecursiveBlock)(int);</div><div class="line">RecursiveBlock = ^(int value) &#123;</div><div class="line">pthread_mutex_lock(&amp;lock);</div><div class="line">if (value &gt; 0) &#123;</div><div class="line">NSLog(@&quot;åŠ é”å±‚æ•° %d&quot;, value);</div><div class="line">sleep(1);</div><div class="line">RecursiveBlock(--value);</div><div class="line">&#125;</div><div class="line">pthread_mutex_unlock(&amp;lock);</div><div class="line">&#125;;</div><div class="line">RecursiveBlock(3);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>è¾“å‡ºç»“æœ(åŒæ ·ï¼Œç»“æœæ˜¾ç¤ºå¹¶æœªå‘ç”Ÿæ­»é”)ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">åŠ é”å±‚æ•° 3</div><div class="line">åŠ é”å±‚æ•° 2</div><div class="line">åŠ é”å±‚æ•° 1</div><div class="line">åŠ é”å±‚æ•° 3</div><div class="line">åŠ é”å±‚æ•° 2</div><div class="line">åŠ é”å±‚æ•° 1</div><div class="line">åŠ é”å±‚æ•° 3</div><div class="line">åŠ é”å±‚æ•° 2</div></pre></td></tr></table></figure>
<h4 id="3ã€ä¿¡å·é‡"><a href="#3ã€ä¿¡å·é‡" class="headerlink" title="3ã€ä¿¡å·é‡"></a>3ã€ä¿¡å·é‡</h4><blockquote>
<p>ä¿¡å·é‡(Semaphore)ï¼Œæœ‰æ—¶è¢«ç§°ä¸ºä¿¡å·ç¯ï¼Œæ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨çš„ä¸€ç§è®¾æ–½ï¼Œæ˜¯å¯ä»¥ç”¨æ¥ä¿è¯ä¸¤ä¸ªæˆ–å¤šä¸ªå…³é”®ä»£ç æ®µä¸è¢«å¹¶å‘è°ƒç”¨ã€‚åœ¨è¿›å…¥ä¸€ä¸ªå…³é”®ä»£ç æ®µä¹‹å‰ï¼Œçº¿ç¨‹å¿…é¡»è·å–ä¸€ä¸ªä¿¡å·é‡ï¼›ä¸€æ—¦è¯¥å…³é”®ä»£ç æ®µå®Œæˆäº†ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å¿…é¡»é‡Šæ”¾ä¿¡å·é‡ã€‚å…¶å®ƒæƒ³è¿›å…¥è¯¥å…³é”®ä»£ç æ®µçš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¿¡å·é‡</p>
</blockquote>
<p><strong>3.1 dispatch_semaphore_t</strong></p>
<ul>
<li>åŒæ­¥å®ç°</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// å‚æ•°å¯ä»¥ç†è§£ä¸ºä¿¡å·çš„æ€»é‡ï¼Œä¼ å…¥çš„å€¼å¿…é¡»å¤§äºæˆ–ç­‰äº0ï¼Œå¦åˆ™ï¼Œè¿”å›NULL</div><div class="line">// dispatch_semaphore_signal + 1</div><div class="line">// dispatch_semaphore_waitç­‰å¾…ä¿¡å·ï¼Œå½“ &lt;= 0ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€</div><div class="line">__block dispatch_semaphore_t semaphore = dispatch_semaphore_create(1);</div><div class="line">MM_GLOBAL_QUEUE(^&#123;</div><div class="line">dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">NSLog(@&quot;è¿™é‡Œç®€å•å†™ä¸€ä¸‹ç”¨æ³•ï¼Œå¯è‡ªè¡Œå®ç°ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…&quot;);</div><div class="line">sleep(1);</div><div class="line">dispatch_semaphore_signal(semaphore);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>3.2 pthread</strong></p>
<ul>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">__block pthread_mutex_t mutex=PTHREAD_MUTEX_INITIALIZER;</div><div class="line">__block pthread_cond_t cond=PTHREAD_COND_INITIALIZER;</div><div class="line"></div><div class="line">MM_GLOBAL_QUEUE(^&#123;</div><div class="line">//NSLog(@&quot;çº¿ç¨‹ 0ï¼šåŠ é”&quot;);</div><div class="line">pthread_mutex_lock(&amp;mutex);</div><div class="line">pthread_cond_wait(&amp;cond, &amp;mutex);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 0ï¼šwait&quot;);</div><div class="line">pthread_mutex_unlock(&amp;mutex);</div><div class="line">//NSLog(@&quot;çº¿ç¨‹ 0ï¼šè§£é”&quot;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">MM_GLOBAL_QUEUE(^&#123;</div><div class="line">//NSLog(@&quot;çº¿ç¨‹ 1ï¼šåŠ é”&quot;);</div><div class="line">sleep(3);//3ç§’å‘ä¸€æ¬¡ä¿¡å·</div><div class="line">pthread_mutex_lock(&amp;mutex);</div><div class="line">NSLog(@&quot;çº¿ç¨‹ 1ï¼šsignal&quot;);</div><div class="line">pthread_cond_signal(&amp;cond);</div><div class="line">pthread_mutex_unlock(&amp;mutex);</div><div class="line">//NSLog(@&quot;çº¿ç¨‹ 1ï¼šåŠ é”&quot;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="4ã€æ¡ä»¶é”"><a href="#4ã€æ¡ä»¶é”" class="headerlink" title="4ã€æ¡ä»¶é”"></a>4ã€æ¡ä»¶é”</h4><p><strong>3.1 NSCodition</strong></p>
<blockquote>
<p>NSCondition çš„å¯¹è±¡å®é™…ä¸Šä½œä¸ºä¸€ä¸ªé”å’Œä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥å™¨ï¼šé”ä¸»è¦ä¸ºäº†å½“æ£€æµ‹æ¡ä»¶æ—¶ä¿æŠ¤æ•°æ®æºï¼Œæ‰§è¡Œæ¡ä»¶å¼•å‘çš„ä»»åŠ¡ï¼›çº¿ç¨‹æ£€æŸ¥å™¨ä¸»è¦æ˜¯æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ç»§ç»­è¿è¡Œçº¿ç¨‹ï¼Œå³çº¿ç¨‹æ˜¯å¦è¢«é˜»å¡ã€‚</p>
</blockquote>
<ul>
<li>NSConditionåŒæ ·å®ç°äº†NSLockingåè®®ï¼Œæ‰€ä»¥å®ƒå’ŒNSLockä¸€æ ·ï¼Œä¹Ÿæœ‰NSLockingåè®®çš„lockå’Œunlockæ–¹æ³•ï¼Œå¯ä»¥å½“åšNSLockæ¥ä½¿ç”¨è§£å†³çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œç”¨æ³•å®Œå…¨ä¸€æ ·ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)getIamgeName:(NSMutableArray *)imageNames&#123;</div><div class="line">NSString *imageName;</div><div class="line">[lock lock];</div><div class="line">if (imageNames.count&gt;0) &#123;</div><div class="line">imageName = [imageNames lastObject];</div><div class="line">[imageNames removeObject:imageName];</div><div class="line">&#125;</div><div class="line">[lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åŒæ—¶ï¼ŒNSConditionæä¾›æ›´é«˜çº§çš„ç”¨æ³•ã€‚waitå’Œsignalï¼Œå’Œæ¡ä»¶ä¿¡å·é‡ç±»ä¼¼ã€‚æ¯”å¦‚æˆ‘ä»¬è¦ç›‘å¬imageNamesæ•°ç»„çš„ä¸ªæ•°ï¼Œå½“imageNamesçš„ä¸ªæ•°å¤§äº0çš„æ—¶å€™å°±æ‰§è¡Œæ¸…ç©ºæ“ä½œã€‚æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œå½“imageNamesä¸ªæ•°å¤§äº0æ—¶æ‰§è¡Œæ¸…ç©ºæ“ä½œï¼Œå¦åˆ™ï¼Œwaitç­‰å¾…æ‰§è¡Œæ¸…ç©ºæ“ä½œã€‚å½“imageNamesä¸ªæ•°å¢åŠ çš„æ—¶å€™å‘ç”Ÿsignalä¿¡å·ï¼Œè®©ç­‰å¾…çš„çº¿ç¨‹å”¤é†’ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>
<ul>
<li><p>NSConditionå’ŒNSLockã€@synchronizedç­‰æ˜¯ä¸åŒçš„æ˜¯ï¼ŒNSConditionå¯ä»¥ç»™æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«åŠ é”ï¼ŒåŠ é”åä¸å½±å“å…¶ä»–çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºã€‚è¿™æ˜¯éå¸¸å¼ºå¤§ã€‚<br>ä½†æ˜¯æ­£æ˜¯å› ä¸ºè¿™ç§åˆ†åˆ«åŠ é”çš„æ–¹å¼ï¼ŒNSConditionä½¿ç”¨waitå¹¶ä½¿ç”¨åŠ é”åå¹¶ä¸èƒ½çœŸæ­£çš„è§£å†³èµ„æºçš„ç«äº‰ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸ªéœ€æ±‚ï¼šä¸èƒ½è®©m<0ã€‚å‡è®¾å½“å‰m=0,çº¿ç¨‹aè¦åˆ¤æ–­åˆ°m>0ä¸ºå‡,æ‰§è¡Œç­‰å¾…ï¼›çº¿ç¨‹Bæ‰§è¡Œäº†m=1æ“ä½œï¼Œå¹¶å”¤é†’çº¿ç¨‹Aæ‰§è¡Œm-1æ“ä½œçš„åŒæ—¶çº¿ç¨‹Cåˆ¤æ–­åˆ°m&gt;0ï¼Œå› ä¸ºä»–ä»¬åœ¨ä¸åŒçš„çº¿ç¨‹é”é‡Œé¢ï¼ŒåŒæ ·åˆ¤æ–­ä¸ºçœŸä¹Ÿæ‰§è¡Œäº†m-1ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹Aå’Œçº¿ç¨‹Céƒ½ä¼šæ‰§è¡Œm-1,ä½†æ˜¯m=1ï¼Œç»“æœå°±ä¼šé€ æˆm=-1.</0ã€‚å‡è®¾å½“å‰m=0,çº¿ç¨‹aè¦åˆ¤æ–­åˆ°m></p>
</li>
<li><p>å½“æˆ‘ç”¨æ•°ç»„åšåˆ é™¤è¯•éªŒæ—¶ï¼Œåšå¢åˆ æ“ä½œå¹¶ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šå‡ºç°ï¼Œå¤§æ¦‚3-4æ¬¡åä¼šå‡ºç°ã€‚å•çº¯çš„ä½¿ç”¨lockã€unlockæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">- (void)getIamgeName:(NSMutableArray *)imageNames&#123;</div><div class="line">NSString *imageName;</div><div class="line">[lock lock];    //åŠ é”</div><div class="line">static int m = 0;</div><div class="line">static int n = 0;</div><div class="line">static int p = 0;</div><div class="line">NSLog(@&quot;removeObjectBegin count: %ld\n&quot;,imageNames.count);</div><div class="line"></div><div class="line">if (imageNames.count&gt;0) &#123;</div><div class="line">imageName = [imageNames lastObject];</div><div class="line">[imageNames removeObjectAtIndex:0];</div><div class="line">m++;</div><div class="line">NSLog(@&quot;æ‰§è¡Œäº†%dæ¬¡åˆ é™¤æ“ä½œ&quot;,m);</div><div class="line">&#125; else &#123;</div><div class="line">p++;</div><div class="line">NSLog(@&quot;æ‰§è¡Œäº†%dæ¬¡ç­‰å¾…&quot;,p);</div><div class="line">[lock wait];    //ç­‰å¾…</div><div class="line">imageName = [imageNames lastObject];</div><div class="line">[imageNames removeObjectAtIndex:0];</div><div class="line">/**</div><div class="line">*  æœ‰æ—¶å€™ç‚¹å‡»å–å‡ºå›¾ç‰‡ä¼šå´©æºƒ</div><div class="line">*/</div><div class="line">n++;</div><div class="line">NSLog(@&quot;æ‰§è¡Œäº†%dæ¬¡ç»§ç»­æ“ä½œ&quot;,n);</div><div class="line">&#125;</div><div class="line"></div><div class="line">NSLog(@&quot;removeObject count: %ld\n&quot;,imageNames.count);</div><div class="line">[lock unlock];     //è§£é”</div><div class="line">&#125;</div><div class="line">- (void)createImageName:(NSMutableArray *)imageNames&#123;</div><div class="line">[lock lock];</div><div class="line">static int m = 0;</div><div class="line">[imageNames addObject:@&quot;0&quot;];</div><div class="line">m++;</div><div class="line">NSLog(@&quot;æ·»åŠ äº†%dæ¬¡&quot;,m);</div><div class="line">[lock signal];  //å”¤é†’éšæœºä¸€ä¸ªçº¿ç¨‹å–æ¶ˆç­‰å¾…ç»§ç»­æ‰§è¡Œ</div><div class="line"></div><div class="line">//        [lock broadcast];   //å”¤é†’æ‰€æœ‰çº¿ç¨‹å–æ¶ˆç­‰å¾…ç»§ç»­æ‰§è¡Œ</div><div class="line">NSLog(@&quot;createImageName count: %ld\n&quot;,imageNames.count);</div><div class="line">[lock unlock];</div><div class="line">&#125;</div><div class="line"></div><div class="line">#pragma mark - å¤šçº¿ç¨‹å–å‡ºå›¾ç‰‡ååˆ é™¤</div><div class="line">- (void)getImageNameWithMultiThread&#123;</div><div class="line">[lock broadcast];</div><div class="line">NSMutableArray *imageNames = [[NSMutableArray alloc]init];</div><div class="line">dispatch_group_t dispatchGroup = dispatch_group_create();</div><div class="line">__block double then, now;</div><div class="line">then = CFAbsoluteTimeGetCurrent();</div><div class="line">for (int i=0; i&lt;10; i++) &#123;</div><div class="line">dispatch_group_async(dispatchGroup, self.synchronizationQueue, ^()&#123;</div><div class="line">[self getIamgeName:imageNames];</div><div class="line">&#125;);</div><div class="line">dispatch_group_async(dispatchGroup, self.synchronizationQueue, ^()&#123;</div><div class="line">[self createImageName:imageNames];</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line">dispatch_group_notify(dispatchGroup, self.synchronizationQueue, ^()&#123;</div><div class="line">now = CFAbsoluteTimeGetCurrent();</div><div class="line">printf(&quot;thread_lock: %f sec\nimageNames count: %ld\n&quot;, now-then,imageNames.count);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3.2 NSCoditionLock</strong></p>
<ul>
<li><p><code>lock</code>ä¸åˆ†æ¡ä»¶ï¼Œå¦‚æœé”æ²¡è¢«ç”³è¯·ï¼Œç›´æ¥æ‰§è¡Œä»£ç </p>
</li>
<li><p><code>unlock</code>ä¸ä¼šæ¸…ç©ºæ¡ä»¶ï¼Œä¹‹åæ»¡è¶³æ¡ä»¶çš„é”è¿˜ä¼šæ‰§è¡Œ</p>
</li>
<li><p><code>unlockWithCondition:</code>æˆ‘çš„ç†è§£å°±æ˜¯è®¾ç½®è§£é”æ¡ä»¶(åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œå¦‚æœå·²ç»è®¾ç½®æ¡ä»¶ï¼Œç›¸å½“äºä¿®æ”¹æ¡ä»¶)</p>
</li>
<li><p><code>lockWhenCondition:</code>æ»¡è¶³ç‰¹å®šæ¡ä»¶,æ‰§è¡Œç›¸åº”ä»£ç </p>
</li>
<li><p>NSConditionLockåŒæ ·å®ç°äº†NSLockingåè®®ï¼Œè¯•éªŒè¿‡ç¨‹ä¸­å‘ç°æ€§èƒ½å¾ˆä½ã€‚</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)getIamgeName:(NSMutableArray *)imageNames&#123;</div><div class="line">NSString *imageName;</div><div class="line">[lock lock];</div><div class="line">if (imageNames.count&gt;0) &#123;</div><div class="line">imageName = [imageNames lastObject];</div><div class="line">[imageNames removeObject:imageName];</div><div class="line">&#125;</div><div class="line">[lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>NSConditionLockä¹Ÿå¯ä»¥åƒNSConditionä¸€æ ·åšå¤šçº¿ç¨‹ä¹‹é—´çš„ä»»åŠ¡ç­‰å¾…è°ƒç”¨ï¼Œè€Œä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">- (void)getIamgeName:(NSMutableArray *)imageNames&#123;</div><div class="line">NSString *imageName;</div><div class="line">[lock lockWhenCondition:1];    //åŠ é”</div><div class="line">if (imageNames.count&gt;0) &#123;</div><div class="line">imageName = [imageNames lastObject];</div><div class="line">[imageNames removeObjectAtIndex:0];</div><div class="line">&#125;</div><div class="line">[lock unlockWithCondition:0];     //è§£é”</div><div class="line">&#125;</div><div class="line">- (void)createImageName:(NSMutableArray *)imageNames&#123;</div><div class="line">[lock lockWhenCondition:0];</div><div class="line">[imageNames addObject:@&quot;0&quot;];</div><div class="line">[lock unlockWithCondition:1];</div><div class="line">&#125;</div><div class="line"></div><div class="line">#pragma mark - å¤šçº¿ç¨‹å–å‡ºå›¾ç‰‡ååˆ é™¤</div><div class="line">- (void)getImageNameWithMultiThread&#123;</div><div class="line">NSMutableArray *imageNames = [[NSMutableArray alloc]init];</div><div class="line">dispatch_group_t dispatchGroup = dispatch_group_create();</div><div class="line">__block double then, now;</div><div class="line">then = CFAbsoluteTimeGetCurrent();</div><div class="line">for (int i=0; i&lt;10000; i++) &#123;</div><div class="line">dispatch_group_async(dispatchGroup, self.synchronizationQueue, ^()&#123;</div><div class="line">[self getIamgeName:imageNames];</div><div class="line">&#125;);</div><div class="line">dispatch_group_async(dispatchGroup, self.synchronizationQueue, ^()&#123;</div><div class="line">[self createImageName:imageNames];</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line">dispatch_group_notify(dispatchGroup, self.synchronizationQueue, ^()&#123;</div><div class="line">now = CFAbsoluteTimeGetCurrent();</div><div class="line">printf(&quot;thread_lock: %f sec\nimageNames count: %ld\n&quot;, now-then,imageNames.count);</div><div class="line">&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3.3 POSIX Conditions</strong></p>
<ul>
<li><p><strong>POSIX</strong>æ¡ä»¶é”éœ€è¦äº’æ–¥é”å’Œæ¡ä»¶ä¸¤é¡¹æ¥å®ç°ï¼Œè™½ç„¶çœ‹èµ·æ¥æ²¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œä½†åœ¨è¿è¡Œæ—¶ä¸­ï¼Œäº’æ–¥é”å°†ä¼šä¸æ¡ä»¶ç»“åˆèµ·æ¥ã€‚çº¿ç¨‹å°†è¢«ä¸€ä¸ªäº’æ–¥å’Œæ¡ä»¶ç»“åˆçš„ä¿¡å·æ¥å”¤é†’ã€‚</p>
</li>
<li><p>é¦–å…ˆåˆå§‹åŒ–æ¡ä»¶å’Œäº’æ–¥é”ï¼Œå½“<code>ready_to_go</code>ä¸º<strong>false</strong>çš„æ—¶å€™ï¼Œè¿›å…¥å¾ªç¯ï¼Œç„¶åçº¿ç¨‹å°†ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å°†<code>ready_to_go</code>è®¾ç½®ä¸ºtrueçš„æ—¶å€™ï¼Œå¹¶ä¸”å‘é€ä¿¡å·çš„æ—¶å€™ï¼Œè¯¥çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’ã€‚</p>
</li>
<li><p>æµ‹è¯•ä»£ç </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">pthread_mutex_t mutex;</div><div class="line">pthread_cond_t condition;</div><div class="line">Boolean     ready_to_go = true;</div><div class="line">void MyCondInitFunction()</div><div class="line">&#123;</div><div class="line">pthread_mutex_init(&amp;mutex);</div><div class="line">pthread_cond_init(&amp;condition, NULL);</div><div class="line">&#125;</div><div class="line">void MyWaitOnConditionFunction()</div><div class="line">&#123;</div><div class="line">// Lock the mutex.</div><div class="line">pthread_mutex_lock(&amp;mutex);</div><div class="line">// If the predicate is already set, then the while loop is bypassed;</div><div class="line">// otherwise, the thread sleeps until the predicate is set.</div><div class="line">while(ready_to_go == false)</div><div class="line">&#123;</div><div class="line">pthread_cond_wait(&amp;condition, &amp;mutex);</div><div class="line">&#125;</div><div class="line">// Do work. (The mutex should stay locked.)</div><div class="line">// Reset the predicate and release the mutex.</div><div class="line">ready_to_go = false;</div><div class="line">pthread_mutex_unlock(&amp;mutex);</div><div class="line">&#125;</div><div class="line">void SignalThreadUsingCondition()</div><div class="line">&#123;</div><div class="line">// At this point, there should be work for the other thread to do.</div><div class="line">pthread_mutex_lock(&amp;mutex);</div><div class="line">ready_to_go = true;</div><div class="line">// Signal the other thread to begin work.</div><div class="line">pthread_cond_signal(&amp;condition);</div><div class="line">pthread_mutex_unlock(&amp;mutex);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="5ã€åˆ†å¸ƒå¼é”"><a href="#5ã€åˆ†å¸ƒå¼é”" class="headerlink" title="5ã€åˆ†å¸ƒå¼é”"></a>5ã€åˆ†å¸ƒå¼é”</h4><blockquote>
<p>åˆ†å¸ƒå¼é”æ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´åŒæ­¥è®¿é—®å…±äº«èµ„æºçš„ä¸€ç§æ–¹å¼ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦åè°ƒä»–ä»¬çš„åŠ¨ä½œã€‚å¦‚æœä¸åŒçš„ç³»ç»Ÿæˆ–æ˜¯åŒä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒä¸»æœºä¹‹é—´å…±äº«äº†ä¸€ä¸ªæˆ–ä¸€ç»„èµ„æºï¼Œé‚£ä¹ˆè®¿é—®è¿™äº›èµ„æºçš„æ—¶å€™ï¼Œå¾€å¾€éœ€è¦äº’æ–¥æ¥é˜²æ­¢å½¼æ­¤å¹²æ‰°æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¾¿éœ€è¦ä½¿ç”¨åˆ°åˆ†å¸ƒå¼é”ã€‚</p>
</blockquote>
<p><strong>5.1 NSDistributedLock</strong></p>
<ul>
<li><p>å¤„ç†å¤šä¸ªè¿›ç¨‹æˆ–å¤šä¸ªç¨‹åºä¹‹é—´äº’æ–¥é—®é¢˜ã€‚</p>
</li>
<li><p>ä¸€ä¸ªè·å–é”çš„è¿›ç¨‹æˆ–ç¨‹åºåœ¨æ˜¯å¦é”ä¹‹å‰æŒ‚æ‰ï¼Œé”ä¸ä¼šè¢«é‡Šæ”¾ï¼Œå¯ä»¥é€šè¿‡breakLockæ–¹å¼è§£é”ã€‚</p>
</li>
<li><p>iOSå¾ˆå°‘ç”¨åˆ°ï¼Œæš‚ä¸è¯¦ç»†ç ”ç©¶ã€‚</p>
</li>
</ul>
<h4 id="6ã€è¯»å†™é”"><a href="#6ã€è¯»å†™é”" class="headerlink" title="6ã€è¯»å†™é”"></a>6ã€è¯»å†™é”</h4><blockquote>
<p>è¯»å†™é”å®é™…æ˜¯ä¸€ç§ç‰¹æ®Šçš„è‡ªæ—‹é”ï¼Œå®ƒæŠŠå¯¹å…±äº«èµ„æºçš„è®¿é—®è€…åˆ’åˆ†æˆè¯»è€…å’Œå†™è€…ï¼Œè¯»è€…åªå¯¹å…±äº«èµ„æºè¿›è¡Œè¯»è®¿é—®ï¼Œå†™è€…åˆ™éœ€è¦å¯¹å…±äº«èµ„æºè¿›è¡Œå†™æ“ä½œã€‚è¿™ç§é”ç›¸å¯¹äºè‡ªæ—‹é”è€Œè¨€ï¼Œèƒ½æé«˜å¹¶å‘æ€§ï¼Œå› ä¸ºåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå®ƒå…è®¸åŒæ—¶æœ‰å¤šä¸ªè¯»è€…æ¥è®¿é—®å…±äº«èµ„æºï¼Œæœ€å¤§å¯èƒ½çš„è¯»è€…æ•°ä¸ºå®é™…çš„é€»è¾‘CPUæ•°ã€‚å†™è€…æ˜¯æ’ä»–æ€§çš„ï¼Œä¸€ä¸ªè¯»å†™é”åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªå†™è€…æˆ–å¤šä¸ªè¯»è€…ï¼ˆä¸CPUæ•°ç›¸å…³ï¼‰ï¼Œä½†ä¸èƒ½åŒæ—¶æ—¢æœ‰è¯»è€…åˆæœ‰å†™è€…ã€‚</p>
</blockquote>
<p><strong>6.1 dispatch_barrier_async / dispatch_barrier_sync</strong></p>
<ul>
<li><p>å…ˆæ¥ä¸€ä¸ªéœ€æ±‚ï¼šå‡è®¾æˆ‘ä»¬åŸå…ˆæœ‰6ä¸ªä»»åŠ¡è¦æ‰§è¡Œï¼Œæˆ‘ä»¬ç°åœ¨è¦æ’å…¥ä¸€ä¸ªä»»åŠ¡0ï¼Œè¿™ä¸ªä»»åŠ¡0è¦åœ¨1ã€2ã€4éƒ½å¹¶å‘æ‰§è¡Œå®Œä¹‹åæ‰èƒ½æ‰§è¡Œï¼Œè€Œ4ã€5ã€6å·ä»»åŠ¡è¦åœ¨è¿™å‡ ä¸ªä»»åŠ¡0ç»“æŸåæ‰å…è®¸å¹¶å‘ã€‚å¤§è‡´çš„æ„æ€å¦‚ä¸‹å›¾<img src="http://img.blog.csdn.net/20150726170216381" alt=""></p>
</li>
<li><p>ç›´æ¥ä¸Šä»£ç ï¼š</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">[super viewDidLoad];</div><div class="line">dispatch_queue_t queue = dispatch_queue_create(&quot;thread&quot;, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">dispatch_async(queue, &#123;</div><div class="line">NSLog(@&quot;test1&quot;);</div><div class="line">&#125;);</div><div class="line">dispatch_async(queue, &#123;</div><div class="line">NSLog(@&quot;test2&quot;);</div><div class="line">&#125;);</div><div class="line">dispatch_async(queue, &#123;</div><div class="line">NSLog(@&quot;test3&quot;);</div><div class="line">&#125;);</div><div class="line">dispatch_barrier_sync(queue, &#123;</div><div class="line">for (int i = 0; i &lt;= 500000000; i++) &#123;</div><div class="line">if (5000 == i) &#123;</div><div class="line">NSLog(@&quot;point1&quot;);</div><div class="line">&#125;else if (6000 == i) &#123;</div><div class="line">NSLog(@&quot;point2&quot;);</div><div class="line">&#125;else if (7000 == i) &#123;</div><div class="line">NSLog(@&quot;point3&quot;);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">NSLog(@&quot;barrier&quot;);</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;aaa&quot;);</div><div class="line">dispatch_async(queue, &#123;</div><div class="line">NSLog(@&quot;test4&quot;);</div><div class="line">&#125;);</div><div class="line">dispatch_async(queue, &#123;</div><div class="line">NSLog(@&quot;test5&quot;);</div><div class="line">&#125;);</div><div class="line">dispatch_async(queue, &#123;</div><div class="line">NSLog(@&quot;test6&quot;);</div><div class="line">&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>å…±åŒç‚¹ï¼š1ã€ç­‰å¾…åœ¨å®ƒå‰é¢æ’å…¥é˜Ÿåˆ—çš„ä»»åŠ¡å…ˆæ‰§è¡Œå®Œï¼›2ã€ç­‰å¾…ä»–ä»¬è‡ªå·±çš„ä»»åŠ¡æ‰§è¡Œå®Œå†æ‰§è¡Œåé¢çš„ä»»åŠ¡ã€‚</p>
</li>
<li><p>ä¸åŒç‚¹ï¼š1ã€dispatch_barrier_syncå°†è‡ªå·±çš„ä»»åŠ¡æ’å…¥åˆ°é˜Ÿåˆ—çš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾…è‡ªå·±çš„ä»»åŠ¡ç»“æŸä¹‹åæ‰ä¼šç»§ç»­æ’å…¥è¢«å†™åœ¨å®ƒåé¢çš„ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œå®ƒä»¬ï¼›2ã€dispatch_barrier_asyncå°†è‡ªå·±çš„ä»»åŠ¡æ’å…¥åˆ°é˜Ÿåˆ—ä¹‹åï¼Œä¸ä¼šç­‰å¾…è‡ªå·±çš„ä»»åŠ¡ç»“æŸï¼Œå®ƒä¼šç»§ç»­æŠŠåé¢çš„ä»»åŠ¡æ’å…¥é˜Ÿåˆ—ï¼Œç„¶åç­‰å¾…è‡ªå·±çš„ä»»åŠ¡ç»“æŸåæ‰æ‰§è¡Œåé¢çš„ä»»åŠ¡ã€‚</p>
</li>
</ul>
<p><strong>6.2 pthread</strong></p>
<ul>
<li>ä¸ä¸Šè¿°åˆå§‹åŒ–æ–¹å¼ç±»ä¼¼ï¼Œé™æ€<code>THREAD_RWLOCK_INITIALIZER</code>ã€åŠ¨æ€<code>pthread_rwlock_init()</code>ã€<code>pthread_rwlock_destroy</code>ç”¨æ¥é”€æ¯è¯¥é”</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">#import &lt;pthread.h&gt;</div><div class="line"></div><div class="line">__block pthread_rwlock_t rwlock;</div><div class="line">pthread_rwlock_init(&amp;rwlock,NULL);</div><div class="line"></div><div class="line">//è¯»</div><div class="line">KYS_GLOBAL_QUEUE(^&#123;</div><div class="line">//NSLog(@&quot;çº¿ç¨‹0ï¼šéšçœ  1 ç§’&quot;);//è¿˜æ˜¯ä¸æ‰“å°èƒ½ç›´è§‚äº›</div><div class="line">sleep(1);</div><div class="line">NSLog(@&quot;çº¿ç¨‹0ï¼šåŠ é”&quot;);</div><div class="line">pthread_rwlock_rdlock(&amp;rwlock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹0ï¼šè¯»&quot;);</div><div class="line">pthread_rwlock_unlock(&amp;rwlock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹0ï¼šè§£é”&quot;);</div><div class="line">&#125;);</div><div class="line">//å†™</div><div class="line">KYS_GLOBAL_QUEUE(^&#123;</div><div class="line">//NSLog(@&quot;çº¿ç¨‹1ï¼šéšçœ  3 ç§’&quot;);</div><div class="line">sleep(3);</div><div class="line">NSLog(@&quot;çº¿ç¨‹1ï¼šåŠ é”&quot;);</div><div class="line">pthread_rwlock_wrlock(&amp;rwlock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹1ï¼šå†™&quot;);</div><div class="line">pthread_rwlock_unlock(&amp;rwlock);</div><div class="line">NSLog(@&quot;çº¿ç¨‹1ï¼šè§£é”&quot;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="7ã€è‡ªæ—‹é”"><a href="#7ã€è‡ªæ—‹é”" class="headerlink" title="7ã€è‡ªæ—‹é”"></a>7ã€è‡ªæ—‹é”</h4><blockquote>
<p> ä½•è°“è‡ªæ—‹é”ï¼Ÿå®ƒæ˜¯ä¸ºå®ç°ä¿æŠ¤å…±äº«èµ„æºè€Œæå‡ºä¸€ç§é”æœºåˆ¶ã€‚å…¶å®ï¼Œè‡ªæ—‹é”ä¸äº’æ–¥é”æ¯”è¾ƒç±»ä¼¼ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸ºäº†è§£å†³å¯¹æŸé¡¹èµ„æºçš„äº’æ–¥ä½¿ç”¨ã€‚æ— è®ºæ˜¯äº’æ–¥é”ï¼Œè¿˜æ˜¯è‡ªæ—‹é”ï¼Œåœ¨ä»»ä½•æ—¶åˆ»ï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªä¿æŒè€…ï¼Œä¹Ÿå°±è¯´ï¼Œåœ¨ä»»ä½•æ—¶åˆ»æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªæ‰§è¡Œå•å…ƒè·å¾—é”ã€‚ä½†æ˜¯ä¸¤è€…åœ¨è°ƒåº¦æœºåˆ¶ä¸Šç•¥æœ‰ä¸åŒã€‚å¯¹äºäº’æ–¥é”ï¼Œå¦‚æœèµ„æºå·²ç»è¢«å ç”¨ï¼Œèµ„æºç”³è¯·è€…åªèƒ½è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ä½†æ˜¯è‡ªæ—‹é”ä¸ä¼šå¼•èµ·è°ƒç”¨è€…ç¡çœ ï¼Œå¦‚æœè‡ªæ—‹é”å·²ç»è¢«åˆ«çš„æ‰§è¡Œå•å…ƒä¿æŒï¼Œè°ƒç”¨è€…å°±ä¸€ç›´å¾ªç¯åœ¨é‚£é‡Œçœ‹æ˜¯å¦è¯¥è‡ªæ—‹é”çš„ä¿æŒè€…å·²ç»é‡Šæ”¾äº†é”ï¼Œâ€è‡ªæ—‹â€ä¸€è¯å°±æ˜¯å› æ­¤è€Œå¾—åã€‚</p>
</blockquote>
<p><strong>7.1 OSSpinLock</strong></p>
<ul>
<li>ä½¿ç”¨æ–¹å¼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// åˆå§‹åŒ–</div><div class="line">spinLock = OS_SPINKLOCK_INIT;</div><div class="line">// åŠ é”</div><div class="line">OSSpinLockLock(&amp;spinLock);</div><div class="line">// è§£é”</div><div class="line">OSSpinLockUnlock(&amp;spinLock);</div></pre></td></tr></table></figure>
<p>ç„¶è€Œï¼Œ<a href="https://github.com/ibireme/YYKit" target="_blank" rel="external">YYKit</a>ä½œè€…çš„æ–‡ç« <a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">ä¸å†å®‰å…¨çš„ OSSpinLock</a>æœ‰è¯´åˆ°è¿™ä¸ªè‡ªæ—‹é”å­˜åœ¨ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ã€‚</p>
<p><strong>7.2 os_unfair_lock</strong></p>
<ul>
<li>è‡ªæ—‹é”å·²ç»ä¸å†å®‰å…¨ï¼Œç„¶åè‹¹æœåˆæ•´å‡ºæ¥ä¸ª os_unfair_lock_t ,è¿™ä¸ªé”è§£å†³äº†ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">os_unfair_lock_t unfairLock;</div><div class="line">unfairLock = &amp;(OS_UNFAIR_LOCK_INIT);</div><div class="line">os_unfair_lock_lock(unfairLock);</div><div class="line">os_unfair_lock_unlock(unfairLock);</div></pre></td></tr></table></figure>
<h4 id="8ã€atomic-property-set-get"><a href="#8ã€atomic-property-set-get" class="headerlink" title="8ã€atomic(property) set / get"></a>8ã€atomic(property) set / get</h4><blockquote>
<p>åˆ©ç”¨<code>set</code> / <code>get</code> æ¥å£çš„å±æ€§å®ç°åŸå­æ“ä½œï¼Œè¿›è€Œç¡®ä¿â€œè¢«å…±äº«â€çš„å˜é‡åœ¨å¤šçº¿ç¨‹ä¸­è¯»å†™å®‰å…¨ï¼Œè¿™å·²ç»æ˜¯ä¸èƒ½æ»¡è¶³éƒ¨åˆ†å¤šçº¿ç¨‹åŒæ­¥è¦æ±‚ã€‚</p>
</blockquote>
<ul>
<li><p>åœ¨å®šä¹‰ <code>property</code> çš„æ—¶å€™ï¼Œ æœ‰<code>atomic</code> å’Œ <code>nonatomic</code>çš„å±æ€§ä¿®é¥°å…³é”®å­—ã€‚</p>
</li>
<li><p>å¯¹äº<code>atomic</code>çš„å±æ€§ï¼Œç³»ç»Ÿç”Ÿæˆçš„ <code>getter/setter</code> ä¼šä¿è¯ getã€set æ“ä½œçš„å®Œæ•´æ€§ï¼Œä¸å—å…¶ä»–çº¿ç¨‹å½±å“ã€‚æ¯”å¦‚ï¼Œçº¿ç¨‹ A çš„ getter æ–¹æ³•è¿è¡Œåˆ°ä¸€åŠï¼Œçº¿ç¨‹ B è°ƒç”¨äº† setterï¼šé‚£ä¹ˆçº¿ç¨‹ A çš„ getter è¿˜æ˜¯èƒ½å¾—åˆ°ä¸€ä¸ªå®Œå¥½æ— æŸçš„å¯¹è±¡ã€‚</p>
</li>
<li><p>è€Œ<code>nonatomic</code>å°±æ²¡æœ‰è¿™ä¸ªä¿è¯äº†ã€‚æ‰€ä»¥ï¼Œ<code>nonatomic</code>çš„é€Ÿåº¦è¦æ¯”<code>atomic</code>å¿«ã€‚</p>
</li>
</ul>
<p>-<br><a href="https://stackoverflow.com/users/1405155/raw3d" target="_blank" rel="external">raw3d</a></p>
<p>Atomic</p>
<ul>
<li>æ˜¯é»˜è®¤çš„</li>
<li>ä¼šä¿è¯ CPU èƒ½åœ¨åˆ«çš„çº¿ç¨‹æ¥è®¿é—®è¿™ä¸ªå±æ€§ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œå®Œå½“å‰æµç¨‹</li>
<li>é€Ÿåº¦ä¸å¿«ï¼Œå› ä¸ºè¦ä¿è¯æ“ä½œæ•´ä½“å®Œæˆ</li>
</ul>
<p>Non-Atomic</p>
<ul>
<li>ä¸æ˜¯é»˜è®¤çš„</li>
<li>æ›´å¿«</li>
<li>çº¿ç¨‹ä¸å®‰å…¨</li>
<li>å¦‚æœ‰ä¸¤ä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå±æ€§ï¼Œä¼šå‡ºç°æ— æ³•é¢„æ–™çš„ç»“æœ</li>
</ul>
<p>-</p>
<p><a href="https://stackoverflow.com/users/661217/vijayendra-tripathi" target="_blank" rel="external">Vijayendra Tripathi</a></p>
<ul>
<li><p>å‡è®¾æœ‰ä¸€ä¸ª atomic çš„å±æ€§ â€œnameâ€ï¼Œå¦‚æœçº¿ç¨‹ A è°ƒ<code>[self setName:@&quot;A&quot;]`ï¼Œçº¿ç¨‹ B è°ƒ</code>[self setName:@â€Bâ€]<code>ï¼Œçº¿ç¨‹ C è°ƒ</code>[self name]``ï¼Œé‚£ä¹ˆæ‰€æœ‰è¿™äº›ä¸åŒçº¿ç¨‹ä¸Šçš„æ“ä½œéƒ½å°†ä¾æ¬¡é¡ºåºæ‰§è¡Œâ€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œ getter/setterï¼Œå…¶ä»–çº¿ç¨‹å°±å¾—ç­‰å¾…ã€‚å› æ­¤ï¼Œå±æ€§ name æ˜¯è¯»/å†™å®‰å…¨çš„ã€‚</p>
</li>
<li><p>ä½†æ˜¯ï¼Œå¦‚æœæœ‰å¦ä¸€ä¸ªçº¿ç¨‹ D åŒæ—¶åœ¨è°ƒ<code>[name release]</code>ï¼Œé‚£å¯èƒ½å°±ä¼šcrashï¼Œå› ä¸º release ä¸å— getter/setter æ“ä½œçš„é™åˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå±æ€§åªèƒ½è¯´æ˜¯è¯»/å†™å®‰å…¨çš„ï¼Œä½†å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºåˆ«çš„çº¿ç¨‹è¿˜èƒ½è¿›è¡Œè¯»å†™ä¹‹å¤–çš„å…¶ä»–æ“ä½œã€‚çº¿ç¨‹å®‰å…¨éœ€è¦å¼€å‘è€…è‡ªå·±æ¥ä¿è¯ã€‚</p>
</li>
<li><p>å¦‚æœ name å±æ€§æ˜¯ nonatomic çš„ï¼Œé‚£ä¹ˆä¸Šé¢ä¾‹å­é‡Œçš„æ‰€æœ‰çº¿ç¨‹ Aã€Bã€Cã€D éƒ½å¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´æ— æ³•é¢„æ–™çš„ç»“æœã€‚å¦‚æœæ˜¯ atomic çš„ï¼Œé‚£ä¹ˆ Aã€Bã€C ä¼šä¸²è¡Œï¼Œè€Œ D è¿˜æ˜¯å¹¶è¡Œçš„ã€‚</p>
</li>
</ul>
<p>-</p>
<ul>
<li>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯atomicä¼šåŠ ä¸€ä¸ªé”æ¥ä¿éšœçº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸”å¼•ç”¨è®¡æ•°ä¼š+1ï¼Œæ¥å‘è°ƒç”¨è€…ä¿è¯è¿™ä¸ªå¯¹è±¡ä¼šä¸€ç›´å­˜åœ¨ã€‚å‡å¦‚ä¸è¿™æ ·åšï¼Œå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹è°ƒsetterï¼Œå¯èƒ½ä¼šå‡ºç°çº¿ç¨‹ç«æ€ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°é™åˆ°0ï¼ŒåŸæ¥é‚£ä¸ªå¯¹è±¡å°±æ˜¯å¦äº†ã€‚</li>
</ul>
<h4 id="9ã€ONCE"><a href="#9ã€ONCE" class="headerlink" title="9ã€ONCE"></a>9ã€ONCE</h4><p><strong>9.1 GCD</strong></p>
<ul>
<li>å¤šç”¨äºåˆ›å»ºå•ä¾‹ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">+ (instancetype) sharedInstance &#123;</div><div class="line">id __instance = nil;</div><div class="line">static dispatch_once_t onceToken;</div><div class="line">dispatch_once(&amp;onceToken, &#123;</div><div class="line">__instance = [[self alloc] init];</div><div class="line">&#125;);</div><div class="line">return __instance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>9.2 pthread</strong></p>
<ul>
<li>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// å®šä¹‰æ–¹æ³•</div><div class="line">void fun() &#123;</div><div class="line">NSLog(@&quot;%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;</div><div class="line">__block pthread_once_t once = PTHREAD_ONCE_INIT;</div><div class="line">MM_GLOBAL_QUEU(^&#123;</div><div class="line">NSLog(@&quot;fun&quot;);</div><div class="line">sleep(1);</div><div class="line">pthread_once(&amp;once, fun);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="ä¸‰ã€æ€§èƒ½å¯¹æ¯”"><a href="#ä¸‰ã€æ€§èƒ½å¯¹æ¯”" class="headerlink" title="ä¸‰ã€æ€§èƒ½å¯¹æ¯”"></a>ä¸‰ã€æ€§èƒ½å¯¹æ¯”</h3><p><strong>åŸºç¡€è¡¨ç°-æ‰€æ“ä½œè€—æ—¶</strong></p>
<p><img src="http://cc.cocimg.com/api/uploads/20160129/1454031867325687.png" alt=""></p>
<p>ä¸Šå›¾æ˜¯å¸¸è§„çš„é”æ“ä½œæ€§èƒ½æµ‹è¯•(iOS7.0SDKï¼ŒiPhone6æ¨¡æ‹Ÿå™¨ï¼ŒYosemite 10.10.5)ï¼Œå‚ç›´æ–¹å‘è¡¨ç¤ºè€—æ—¶ï¼Œå•ä½æ˜¯ç§’ï¼Œæ€»è€—æ—¶è¶Šå°è¶Šå¥½ï¼Œæ°´å¹³æ–¹å‘è¡¨ç¤ºä¸åŒç±»å‹é”çš„é”æ“ä½œï¼Œå…·ä½“åˆåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå·¦è¾¹çš„å¸¸è§„lockæ“ä½œ(æ¯”å¦‚NSLock)æˆ–è€…è¯»readæ“ä½œ(æ¯”å¦‚<a href="https://github.com/SpringOx/ANLock" target="_blank" rel="external">ANReadWriteLock</a>)ï¼Œå³è¾¹åˆ™æ˜¯å†™writeæ“ä½œï¼Œå›¾ä¸Šä»…æœ‰<a href="https://github.com/SpringOx/ANLock" target="_blank" rel="external">ANReadWriteLock</a>å’Œ<a href="https://github.com/SpringOx/ANLock" target="_blank" rel="external">ANRecursiveRWLock</a>æ”¯æŒï¼Œå…¶å®ƒä¸æ”¯æŒçš„åˆ™é»˜è®¤ä¸º0ï¼Œå›¾ä¸Šçœ‹å‡ºï¼Œå•ä»æ€§èƒ½è¡¨ç°ï¼ŒåŸå­æ“ä½œæ˜¯è¡¨ç°æœ€ä½³çš„(0.057412ç§’)ï¼Œ@synchronizedåˆ™æ˜¯æœ€è€—æ—¶çš„(1.753565ç§’) (æµ‹è¯•ä»£ç ) ã€‚</p>
<p><strong>å¤šçº¿ç¨‹é”åˆ é™¤æ•°ç»„æ€§èƒ½æµ‹è¯•</strong></p>
<ul>
<li>æ¨¡æ‹Ÿå™¨ç¯å¢ƒï¼ši5 2.6GH+8G å†…å­˜ï¼Œxcode 7.2.1 (7C1002)+iPhone6SP(9.2)</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1024259-9363902b817ceba0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<ul>
<li>çœŸæœºç¯å¢ƒï¼šxcode 7.2.1 (7C1002)+iPhone6(å›½è¡Œ)</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1024259-80b7739e80b2bb52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<ul>
<li><p>é€šè¿‡æµ‹è¯•å‘ç°æ¨¡æ‹Ÿå™¨å’ŒçœŸæœºçš„åŒºåˆ«è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œæ¨¡æ‹Ÿå™¨ä¸Šæ˜æ˜¾çš„é˜¶æ¢¯æ„Ÿï¼ŒçœŸæœºå°±æ²¡æœ‰ï¼Œæ¨¡æ‹Ÿå™¨ä¸ŠNSConditionLockçš„æ€§èƒ½éå¸¸å·®ï¼Œæˆ‘æ²¡æœ‰æŠŠå®ƒçš„å‚æ•°åŠ åœ¨è¡¨æ ¼ä¸Šï¼Œä¸ç„¶å…¶ä»–çš„å°±çœ‹ä¸åˆ°äº†ã€‚ä¸è¿‡çœŸæœºä¸Šé¢æ€§èƒ½è¿˜å¥½ã€‚</p>
</li>
<li><p>è¿™äº›æ€§èƒ½æµ‹è¯•åªæ˜¯ä¸€ä¸ªå‚è€ƒï¼Œæ²¡å¿…è¦éè¦å»åœ¨æ„è¿™äº›ï¼Œæ¯•ç«Ÿå‰ç«¯çš„ç¼–ç¨‹ä¸€èˆ¬çº¿ç¨‹è¦æ±‚æ²¡é‚£ä¹ˆé«˜ï¼Œå¯ä»¥ä»å…¶ä»–çš„åœ°æ–¹ä¼˜åŒ–ã€‚çº¿ç¨‹å®‰å…¨ä¸­æ³¨æ„é¿å‘ï¼Œå¦å¤–é€‰æ‹©è‡ªå·±å–œæ¬¢çš„æ–¹å¼ï¼Œè¿™æ ·ä½ å¯ä»¥ç ”ç©¶çš„æ›´æ·±å…¥ï¼Œä½¿ç”¨çš„æ›´ç†Ÿç»ƒã€‚</p>
</li>
</ul>
<p><strong>å£°æ˜</strong>ï¼š æµ‹è¯•ç»“æœä»…ä»…ä»£è¡¨ä¸€ä¸ªå‚è€ƒï¼Œå› ä¸ºå„ç§å› ç´ çš„å½±å“ï¼Œå¹¶æ²¡æœ‰é‚£ä¹ˆå‡†ç¡®ã€‚</p>
<p><strong>ç»¼åˆæ¯”è¾ƒ</strong></p>
<p><img src="https://blog.ibireme.com/wp-content/uploads/2016/01/lock_benchmark.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°é™¤äº† <strong>OSSpinLock</strong> å¤–ï¼Œ<strong>dispatch_semaphore</strong> å’Œ <strong>pthread_mutex</strong> æ€§èƒ½æ˜¯æœ€é«˜çš„ã€‚æœ‰æ¶ˆæ¯ç§°ï¼Œè‹¹æœåœ¨æ–°çš„ç³»ç»Ÿä¸­å·²ç»ä¼˜åŒ–äº† <strong>pthread_mutex</strong> çš„æ€§èƒ½ï¼Œæ‰€æœ‰å®ƒçœ‹ä¸Šå»å’Œ <strong>pthread_mutex</strong> å·®è·å¹¶æ²¡æœ‰é‚£ä¹ˆå¤§äº†ã€‚</p>
<h3 id="å››ã€å¸¸è§çš„æ­»é”"><a href="#å››ã€å¸¸è§çš„æ­»é”" class="headerlink" title="å››ã€å¸¸è§çš„æ­»é”"></a>å››ã€å¸¸è§çš„æ­»é”</h3><p><strong>é¦–å…ˆè¦æ˜ç¡®å‡ ä¸ªæ¦‚å¿µ</strong></p>
<h4 id="1-ä¸²è¡Œä¸å¹¶è¡Œ"><a href="#1-ä¸²è¡Œä¸å¹¶è¡Œ" class="headerlink" title="1.ä¸²è¡Œä¸å¹¶è¡Œ"></a>1.ä¸²è¡Œä¸å¹¶è¡Œ</h4><p>åœ¨ä½¿ç”¨GCDçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæŠŠéœ€è¦å¤„ç†çš„ä»»åŠ¡æ”¾åˆ°Blockä¸­ï¼Œç„¶åå°†ä»»åŠ¡è¿½åŠ åˆ°ç›¸åº”çš„é˜Ÿåˆ—é‡Œé¢ï¼Œè¿™ä¸ªé˜Ÿåˆ—ï¼Œå«åš <strong>Dispatch Queue</strong>ã€‚ç„¶è€Œï¼Œå­˜åœ¨äºä¸¤ç§<strong>Dispatch Queue</strong>ï¼Œä¸€ç§æ˜¯è¦ç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªçš„<strong>Serial Dispatch Queue</strong>ï¼Œè¿™å«åšä¸²è¡Œé˜Ÿåˆ—ï¼›å¦ä¸€ç§ï¼Œåˆ™æ˜¯ä¸éœ€è¦ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œå°±èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªçš„<strong>ConcurrentDispatch Queue</strong>ï¼Œå«åšå¹¶è¡Œé˜Ÿåˆ—ã€‚è¿™ä¸¤ç§ï¼Œå‡éµå¾ª<strong>FIFO</strong>åŸåˆ™ã€‚</p>
<blockquote>
<p>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸‰ä¸ªä»»åŠ¡ä¸­è¾“å‡º1ã€2ã€3ï¼Œä¸²è¡Œé˜Ÿåˆ—è¾“å‡ºæ˜¯æœ‰åºçš„1ã€2ã€3ï¼Œä½†æ˜¯å¹¶è¡Œé˜Ÿåˆ—çš„å…ˆåé¡ºåºå°±ä¸ä¸€å®šäº†ã€‚</p>
</blockquote>
<p>è™½ç„¶å¯ä»¥åŒæ—¶å¤šä¸ªä»»åŠ¡çš„å¤„ç†ï¼Œä½†æ˜¯å¹¶è¡Œé˜Ÿåˆ—çš„å¤„ç†é‡ï¼Œè¿˜æ˜¯è¦æ ¹æ®å½“å‰ç³»ç»ŸçŠ¶æ€æ¥ã€‚å¦‚æœå½“å‰ç³»ç»ŸçŠ¶æ€æœ€å¤šå¤„ç†2ä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆ1ã€2ä¼šæ’åœ¨å‰é¢ï¼Œ3ä»€ä¹ˆæ—¶å€™æ“ä½œï¼Œå°±çœ‹1æˆ–è€…2è°å…ˆå®Œæˆï¼Œç„¶å3æ¥åœ¨åé¢ã€‚</p>
<p>ä¸²è¡Œå’Œå¹¶è¡Œå°±ç®€å•è¯´åˆ°è¿™é‡Œï¼Œå…³äºå®ƒä»¬çš„æŠ€æœ¯ç‚¹å…¶å®è¿˜æœ‰å¾ˆå¤šï¼Œå¯ä»¥è‡ªè¡Œäº†è§£ã€‚</p>
<h4 id="2-åŒæ­¥ä¸å¼‚æ­¥"><a href="#2-åŒæ­¥ä¸å¼‚æ­¥" class="headerlink" title="2.åŒæ­¥ä¸å¼‚æ­¥"></a>2.åŒæ­¥ä¸å¼‚æ­¥</h4><p>ä¸²è¡Œä¸å¹¶è¡Œé’ˆå¯¹çš„æ˜¯é˜Ÿåˆ—ï¼Œè€ŒåŒæ­¥ä¸å¼‚æ­¥ï¼Œé’ˆå¯¹çš„åˆ™æ˜¯çº¿ç¨‹ã€‚æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼ŒåŒæ­¥çº¿ç¨‹è¦é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¿…é¡»è¦ç­‰å¾…åŒæ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œï¼Œè¿”å›ä»¥åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼›è€Œå¼‚æ­¥çº¿ç¨‹åˆ™æ˜¯ä¸ç”¨ç­‰å¾…ã€‚</p>
<h4 id="3-GCD-API"><a href="#3-GCD-API" class="headerlink" title="3.GCD API"></a>3.GCD API</h4><p>GCD APIå¾ˆå¤šï¼Œè¿™é‡Œä»…ä»‹ç»æœ¬æ–‡ç”¨åˆ°çš„ã€‚</p>
<ul>
<li><ol>
<li>ç³»ç»Ÿæä¾›çš„ä¸¤ä¸ªé˜Ÿåˆ—</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// å…¨å±€é˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</div><div class="line">dispatch_get_global_queue</div><div class="line">// ä¸»é˜Ÿåˆ—ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œå› ä¸ºä¸»çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œæ‰€æœ‰è¿™æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—</div><div class="line">dispatch_get_main_queue</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è‡ªå·±ç”Ÿæˆé˜Ÿåˆ—</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// ä»DISPATCH_QUQUE_SERIALçœ‹å‡ºï¼Œè¿™æ˜¯ä¸²è¡Œé˜Ÿåˆ—</div><div class="line">dispatch_queue_create(&quot;com.demo.serialQueue&quot;, DISPATCH_QUEUE_SERIAL)</div><div class="line">// åŒç†ï¼Œè¿™æ˜¯ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</div><div class="line">dispatch_queue_create(&quot;com.demo.concurrentQueue&quot;, DISPATCH_QUEUE_CONCURRENT)</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>æ¥ä¸‹æ¥æ˜¯åŒæ­¥ä¸å¼‚æ­¥çº¿ç¨‹çš„åˆ›é€ </li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dispatch_sync(..., ^(block)) // åŒæ­¥çº¿ç¨‹</div><div class="line">dispatch_async(..., ^(block)) // å¼‚æ­¥çº¿ç¨‹</div></pre></td></tr></table></figure>
<h4 id="æ¡ˆä¾‹åˆ†æ"><a href="#æ¡ˆä¾‹åˆ†æ" class="headerlink" title="æ¡ˆä¾‹åˆ†æ"></a>æ¡ˆä¾‹åˆ†æ</h4><h5 id="æ¡ˆä¾‹ä¸€"><a href="#æ¡ˆä¾‹ä¸€" class="headerlink" title="æ¡ˆä¾‹ä¸€"></a>æ¡ˆä¾‹ä¸€</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">NSLog(@&quot;1&quot;); // ä»»åŠ¡1</div><div class="line">dispatch_sync(dispatch_get_main_queue(), ^&#123;</div><div class="line">NSLog(@&quot;2&quot;); // ä»»åŠ¡2</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;3&quot;); // ä»»åŠ¡3</div></pre></td></tr></table></figure>
<ul>
<li>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1</div></pre></td></tr></table></figure>
<p><strong>åˆ†æ</strong></p>
<ul>
<li><ol>
<li>dispatch_syncè¡¨ç¤ºä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼›</li>
</ol>
</li>
<li><ol>
<li>dispatch_get_main_queueè¡¨ç¤ºè¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ä¸»é˜Ÿåˆ—ï¼›</li>
</ol>
</li>
<li><ol>
<li>ä»»åŠ¡2æ˜¯åŒæ­¥çº¿ç¨‹çš„ä»»åŠ¡ã€‚</li>
</ol>
</li>
</ul>
<p>é¦–å…ˆæ‰§è¡Œä»»åŠ¡1ï¼Œè¿™æ˜¯è‚¯å®šæ²¡é—®é¢˜çš„ï¼Œåªæ˜¯æ¥ä¸‹æ¥ï¼Œç¨‹åºé‡åˆ°äº†åŒæ­¥çº¿ç¨‹ï¼Œé‚£ä¹ˆå®ƒä¼šè¿›å…¥ç­‰å¾…ï¼Œç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œï¼Œç„¶åæ‰§è¡Œä»»åŠ¡3ã€‚ä½†è¿™æ˜¯é˜Ÿåˆ—ï¼Œæœ‰ä»»åŠ¡æ¥ï¼Œå½“ç„¶ä¼šå°†ä»»åŠ¡åŠ åˆ°é˜Ÿå°¾ï¼Œç„¶åéµå¾ªFIFOåŸåˆ™æ‰§è¡Œä»»åŠ¡ã€‚é‚£ä¹ˆï¼Œç°åœ¨ä»»åŠ¡2å°±ä¼šè¢«åŠ åˆ°æœ€åï¼Œä»»åŠ¡3æ’åœ¨äº†ä»»åŠ¡2å‰é¢ï¼Œé—®é¢˜æ¥äº†ï¼š</p>
<blockquote>
<p>ä»»åŠ¡3è¦ç­‰ä»»åŠ¡2æ‰§è¡Œå®Œæ‰èƒ½æ‰§è¡Œï¼Œä»»åŠ¡2ç”±æ’åœ¨ä»»åŠ¡3åé¢ï¼Œæ„å‘³ç€ä»»åŠ¡2è¦åœ¨ä»»åŠ¡3æ‰§è¡Œå®Œæ‰èƒ½æ‰§è¡Œï¼Œæ‰€ä»¥ä»–ä»¬è¿›å…¥äº†äº’ç›¸ç­‰å¾…çš„å±€é¢ã€‚ã€æ—¢ç„¶è¿™æ ·ï¼Œé‚£å¹²è„†å°±å¡åœ¨è¿™é‡Œå§ã€‘è¿™å°±æ˜¯æ­»é”ã€‚</p>
</blockquote>
<p><img src="http://ww3.sinaimg.cn/mw690/0064cTs2jw1ewev3nwkpzj30sg0l3412.jpg" alt=""></p>
<h5 id="æ¡ˆä¾‹äºŒ"><a href="#æ¡ˆä¾‹äºŒ" class="headerlink" title="æ¡ˆä¾‹äºŒ"></a>æ¡ˆä¾‹äºŒ</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">NSLog(@&quot;1&quot;); // ä»»åŠ¡1</div><div class="line">dispatch_sync(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</div><div class="line">NSLog(@&quot;2&quot;); // ä»»åŠ¡2</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;3&quot;); // ä»»åŠ¡3</div></pre></td></tr></table></figure>
<ul>
<li>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure>
<p><strong>åˆ†æ</strong></p>
<p>é¦–å…ˆæ‰§è¡Œä»»åŠ¡1ï¼Œæ¥ä¸‹æ¥ä¼šé‡åˆ°ä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼Œç¨‹åºä¼šè¿›å…¥ç­‰å¾…ã€‚ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆä»¥åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œä»»åŠ¡3ã€‚ä»dispatch_get_global_queueå¯ä»¥çœ‹å‡ºï¼Œä»»åŠ¡2è¢«åŠ å…¥åˆ°äº†å…¨å±€çš„å¹¶è¡Œé˜Ÿåˆ—ä¸­ï¼Œå½“å¹¶è¡Œé˜Ÿåˆ—æ‰§è¡Œå®Œä»»åŠ¡2ä»¥åï¼Œè¿”å›åˆ°ä¸»é˜Ÿåˆ—ï¼Œç»§ç»­æ‰§è¡Œä»»åŠ¡3ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/mw690/0064cTs2jw1ewev3oimsbj30sg0p30we.jpg" alt=""></p>
<h5 id="æ¡ˆä¾‹ä¸‰"><a href="#æ¡ˆä¾‹ä¸‰" class="headerlink" title="æ¡ˆä¾‹ä¸‰"></a>æ¡ˆä¾‹ä¸‰</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">dispatch_queue_t queue = dispatch_queue_create(&quot;com.demo.serialQueue&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">NSLog(@&quot;1&quot;); // ä»»åŠ¡1</div><div class="line">dispatch_async(queue, ^&#123;</div><div class="line">NSLog(@&quot;2&quot;); // ä»»åŠ¡2</div><div class="line">dispatch_sync(queue, ^&#123;</div><div class="line">NSLog(@&quot;3&quot;); // ä»»åŠ¡3</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;4&quot;); // ä»»åŠ¡4</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;5&quot;); // ä»»åŠ¡5</div></pre></td></tr></table></figure>
<ul>
<li>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">5</div><div class="line">2</div><div class="line">// 5å’Œ2çš„é¡ºåºä¸ä¸€å®š</div></pre></td></tr></table></figure>
<p><strong>åˆ†æ</strong></p>
<p>è¿™ä¸ªæ¡ˆä¾‹æ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ä¸²è¡Œæˆ–å¹¶è¡Œé˜Ÿåˆ—ï¼Œè€Œæ˜¯è‡ªå·±é€šè¿‡dispatch_queue_createå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªDISPATCH_QUEUE_SERIALçš„ä¸²è¡Œé˜Ÿåˆ—ã€‚</p>
<ul>
<li><ol>
<li>æ‰§è¡Œä»»åŠ¡1ï¼›</li>
</ol>
</li>
<li><ol>
<li>é‡åˆ°å¼‚æ­¥çº¿ç¨‹ï¼Œå°†ã€ä»»åŠ¡2ã€åŒæ­¥çº¿ç¨‹ã€ä»»åŠ¡4ã€‘åŠ å…¥ä¸²è¡Œé˜Ÿåˆ—ä¸­ã€‚å› ä¸ºæ˜¯å¼‚æ­¥çº¿ç¨‹ï¼Œæ‰€ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­çš„ä»»åŠ¡5ä¸å¿…ç­‰å¾…å¼‚æ­¥çº¿ç¨‹ä¸­çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼›</li>
</ol>
</li>
<li><ol>
<li>å› ä¸ºä»»åŠ¡5ä¸å¿…ç­‰å¾…ï¼Œæ‰€ä»¥2å’Œ5çš„è¾“å‡ºé¡ºåºä¸èƒ½ç¡®å®šï¼›</li>
</ol>
</li>
<li><ol>
<li>ä»»åŠ¡2æ‰§è¡Œå®Œä»¥åï¼Œé‡åˆ°åŒæ­¥çº¿ç¨‹ï¼Œè¿™æ—¶ï¼Œå°†ä»»åŠ¡3åŠ å…¥ä¸²è¡Œé˜Ÿåˆ—ï¼›</li>
</ol>
</li>
<li><ol>
<li>åˆå› ä¸ºä»»åŠ¡4æ¯”ä»»åŠ¡3æ—©åŠ å…¥ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥ï¼Œä»»åŠ¡3è¦ç­‰å¾…ä»»åŠ¡4å®Œæˆä»¥åï¼Œæ‰èƒ½æ‰§è¡Œã€‚ä½†æ˜¯ä»»åŠ¡3æ‰€åœ¨çš„åŒæ­¥çº¿ç¨‹ä¼šé˜»å¡ï¼Œæ‰€ä»¥ä»»åŠ¡4å¿…é¡»ç­‰ä»»åŠ¡3æ‰§è¡Œå®Œä»¥åå†æ‰§è¡Œã€‚è¿™å°±åˆé™·å…¥äº†æ— é™çš„ç­‰å¾…ä¸­ï¼Œé€ æˆæ­»é”ã€‚</li>
</ol>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/mw690/0064cTs2jw1ewev3p5j6pj30sg0iggpc.jpg" alt=""></p>
<h5 id="æ¡ˆä¾‹å››"><a href="#æ¡ˆä¾‹å››" class="headerlink" title="æ¡ˆä¾‹å››"></a>æ¡ˆä¾‹å››</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">NSLog(@&quot;1&quot;); // ä»»åŠ¡1</div><div class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</div><div class="line">NSLog(@&quot;2&quot;); // ä»»åŠ¡2</div><div class="line">dispatch_sync(dispatch_get_main_queue(), ^&#123;</div><div class="line">NSLog(@&quot;3&quot;); // ä»»åŠ¡3</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;4&quot;); // ä»»åŠ¡4</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;5&quot;); // ä»»åŠ¡5</div></pre></td></tr></table></figure>
<ul>
<li>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">5</div><div class="line">3</div><div class="line">4</div><div class="line">// 5å’Œ2çš„é¡ºåºä¸ä¸€å®š</div></pre></td></tr></table></figure>
<p><strong>åˆ†æ</strong></p>
<p>é¦–å…ˆï¼Œå°†ã€ä»»åŠ¡1ã€å¼‚æ­¥çº¿ç¨‹ã€ä»»åŠ¡5ã€‘åŠ å…¥Main Queueä¸­ï¼Œå¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ˜¯ï¼šã€ä»»åŠ¡2ã€åŒæ­¥çº¿ç¨‹ã€ä»»åŠ¡4ã€‘ã€‚</p>
<p>æ‰€ä»¥ï¼Œå…ˆæ‰§è¡Œä»»åŠ¡1ï¼Œç„¶åå°†å¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡åŠ å…¥åˆ°Global Queueä¸­ï¼Œå› ä¸ºå¼‚æ­¥çº¿ç¨‹ï¼Œæ‰€ä»¥ä»»åŠ¡5ä¸ç”¨ç­‰å¾…ï¼Œç»“æœå°±æ˜¯2å’Œ5çš„è¾“å‡ºé¡ºåºä¸ä¸€å®šã€‚</p>
<p>ç„¶åå†çœ‹å¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œé¡ºåºã€‚ä»»åŠ¡2æ‰§è¡Œå®Œä»¥åï¼Œé‡åˆ°åŒæ­¥çº¿ç¨‹ã€‚å°†åŒæ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡åŠ å…¥åˆ°Main Queueä¸­ï¼Œè¿™æ—¶åŠ å…¥çš„ä»»åŠ¡3åœ¨ä»»åŠ¡5çš„åé¢ã€‚</p>
<p>å½“ä»»åŠ¡3æ‰§è¡Œå®Œä»¥åï¼Œæ²¡æœ‰äº†é˜»å¡ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œä»»åŠ¡4ã€‚</p>
<p>ä»ä»¥ä¸Šçš„åˆ†ææ¥çœ‹ï¼Œå¾—åˆ°çš„å‡ ä¸ªç»“æœï¼š1æœ€å…ˆæ‰§è¡Œï¼›2å’Œ5é¡ºåºä¸ä¸€å®šï¼›4ä¸€å®šåœ¨3åé¢ã€‚</p>
<p><img src="http://ww4.sinaimg.cn/mw690/0064cTs2jw1ewev3pjumnj30sg0mgwir.jpg" alt=""></p>
<h5 id="æ¡ˆä¾‹äº”"><a href="#æ¡ˆä¾‹äº”" class="headerlink" title="æ¡ˆä¾‹äº”"></a>æ¡ˆä¾‹äº”</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</div><div class="line">NSLog(@&quot;1&quot;); // ä»»åŠ¡1</div><div class="line">dispatch_sync(dispatch_get_main_queue(), ^&#123;</div><div class="line">NSLog(@&quot;2&quot;); // ä»»åŠ¡2</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;3&quot;); // ä»»åŠ¡3</div><div class="line">&#125;);</div><div class="line">NSLog(@&quot;4&quot;); // ä»»åŠ¡4</div><div class="line">while (1) &#123;</div><div class="line">&#125;</div><div class="line">NSLog(@&quot;5&quot;); // ä»»åŠ¡5</div></pre></td></tr></table></figure>
<ul>
<li>ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">4</div><div class="line">// 1å’Œ4çš„é¡ºåºä¸ä¸€å®š</div></pre></td></tr></table></figure>
<p><strong>åˆ†æ</strong></p>
<p>å’Œä¸Šé¢å‡ ä¸ªæ¡ˆä¾‹çš„åˆ†æç±»ä¼¼ï¼Œå…ˆæ¥çœ‹çœ‹éƒ½æœ‰å“ªäº›ä»»åŠ¡åŠ å…¥äº†Main Queueï¼šã€å¼‚æ­¥çº¿ç¨‹ã€ä»»åŠ¡4ã€æ­»å¾ªç¯ã€ä»»åŠ¡5ã€‘ã€‚</p>
<p>åœ¨åŠ å…¥åˆ°Global Queueå¼‚æ­¥çº¿ç¨‹ä¸­çš„ä»»åŠ¡æœ‰ï¼šã€ä»»åŠ¡1ã€åŒæ­¥çº¿ç¨‹ã€ä»»åŠ¡3ã€‘ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå°±æ˜¯å¼‚æ­¥çº¿ç¨‹ï¼Œä»»åŠ¡4ä¸ç”¨ç­‰å¾…ï¼Œæ‰€ä»¥ç»“æœä»»åŠ¡1å’Œä»»åŠ¡4é¡ºåºä¸ä¸€å®šã€‚</p>
<p>ä»»åŠ¡4å®Œæˆåï¼Œç¨‹åºè¿›å…¥æ­»å¾ªç¯ï¼ŒMain Queueé˜»å¡ã€‚ä½†æ˜¯åŠ å…¥åˆ°Global Queueçš„å¼‚æ­¥çº¿ç¨‹ä¸å—å½±å“ï¼Œç»§ç»­æ‰§è¡Œä»»åŠ¡1åé¢çš„åŒæ­¥çº¿ç¨‹ã€‚</p>
<p>åŒæ­¥çº¿ç¨‹ä¸­ï¼Œå°†ä»»åŠ¡2åŠ å…¥åˆ°äº†ä¸»çº¿ç¨‹ï¼Œå¹¶ä¸”ï¼Œä»»åŠ¡3ç­‰å¾…ä»»åŠ¡2å®Œæˆä»¥åæ‰èƒ½æ‰§è¡Œã€‚è¿™æ—¶çš„ä¸»çº¿ç¨‹ï¼Œå·²ç»è¢«æ­»å¾ªç¯é˜»å¡äº†ã€‚æ‰€ä»¥ä»»åŠ¡2æ— æ³•æ‰§è¡Œï¼Œå½“ç„¶ä»»åŠ¡3ä¹Ÿæ— æ³•æ‰§è¡Œï¼Œåœ¨æ­»å¾ªç¯åçš„ä»»åŠ¡5ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚</p>
<p>æœ€ç»ˆï¼Œåªèƒ½å¾—åˆ°1å’Œ4é¡ºåºä¸å®šçš„ç»“æœã€‚</p>
<p><img src="http://ww1.sinaimg.cn/mw690/0064cTs2jw1ewev3q5d5ej30sg0jl0w1.jpg" alt=""></p>
<h3 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h3><ul>
<li><ol>
<li>æ€»çš„æ¥çœ‹ï¼Œæ¨èpthread_mutexä½œä¸ºå®é™…é¡¹ç›®çš„é¦–é€‰æ–¹æ¡ˆï¼›</li>
</ol>
</li>
<li><ol>
<li>å¯¹äºè€—æ—¶è¾ƒå¤§åˆæ˜“å†²çªçš„è¯»æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨è¯»å†™é”ä»£æ›¿pthread_mutexï¼›</li>
</ol>
</li>
<li><ol>
<li>å¦‚æœç¡®è®¤ä»…æœ‰set/getçš„è®¿é—®æ“ä½œï¼Œå¯ä»¥é€‰ç”¨åŸå­æ“ä½œå±æ€§ï¼›</li>
</ol>
</li>
<li><ol>
<li>å¯¹äºæ€§èƒ½è¦æ±‚è‹›åˆ»ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨OSSpinLockï¼Œéœ€è¦ç¡®ä¿åŠ é”ç‰‡æ®µçš„è€—æ—¶è¶³å¤Ÿå°ï¼›</li>
</ol>
</li>
<li><ol>
<li>æ¡ä»¶é”åŸºæœ¬ä¸Šä½¿ç”¨é¢å‘å¯¹è±¡çš„NSConditionå’ŒNSConditionLockå³å¯ï¼›</li>
</ol>
</li>
<li><ol>
<li>@synchronizedåˆ™é€‚ç”¨äºä½é¢‘åœºæ™¯å¦‚åˆå§‹åŒ–æˆ–è€…ç´§æ€¥ä¿®å¤ä½¿ç”¨ï¼›</li>
</ol>
</li>
</ul>
<p>è‹¹æœä¸ºå¤šçº¿ç¨‹ã€å…±äº«å†…å­˜æä¾›äº†å¤šç§åŒæ­¥è§£å†³æ–¹æ¡ˆ(é”),å¯¹äºè¿™äº›æ–¹æ¡ˆçš„æ¯”è¾ƒï¼Œå¤§éƒ½è®¨è®ºäº†é”çš„ç”¨æ³•ä»¥åŠé”æ“ä½œçš„å¼€é”€ã€‚ä¸ªäººè®¤ä¸ºæœ€ä¼˜ç§€çš„é€‰ç”¨è¿˜æ˜¯çœ‹åº”ç”¨åœºæ™¯ï¼Œé«˜é¢‘æ¥å£VSä½é¢‘æ¥å£ã€æœ‰é™å†²çªVSæ¿€çƒˆç«äº‰ã€ä»£ç ç‰‡æ®µè€—æ—¶çš„é•¿çŸ­ï¼Œéƒ½æ˜¯é€‰æ‹©çš„é‡è¦ä¾æ®ï¼Œé€‰æ‹©é€‚ç”¨äºå½“å‰åº”ç”¨åœºæ™¯çš„æ–¹æ¡ˆæ‰æ˜¯ç‹é“ã€‚</p>
<h3 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h3><ul>
<li><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html#//apple_ref/doc/uid/10000057i" target="_blank" rel="external">Threading Programming Guide</a></li>
<li><a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="external">ä¸å†å®‰å…¨çš„ OSSpinLock</a></li>
<li><a href="http://www.jianshu.com/p/a33959324cc7" target="_blank" rel="external">iOS é”çš„ç®€å•å®ç°ä¸æ€»ç»“</a></li>
<li><a href="http://www.jianshu.com/p/6c8bf19eb10d" target="_blank" rel="external">iOSä¸­çš„å„ç§é”</a></li>
<li><a href="http://www.cocoachina.com/ios/20150513/11808.html" target="_blank" rel="external">NSRecursiveLocké€’å½’é”çš„ä½¿ç”¨</a></li>
<li><a href="http://www.brighttj.com/ios/ios-gcd-deadlock.html" target="_blank" rel="external">iOS GCDæ­»é”</a></li>
</ul>

      
    </div>
    
    
    

    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------æœ¬æ–‡ç»“æŸ<i class="fa fa-paw"></i>æ„Ÿè°¢æ‚¨çš„é˜…è¯»-------------</div>
    
</div>

      </div>
    

    
      <div>
        
      </div>
     
     


    

    

    

    <footer class="post-footer">
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">åˆ†äº«åˆ°ï¼š</span>
<a class="jiathis_button_fav">æ”¶è—å¤¹</a>
<a class="jiathis_button_copy">å¤åˆ¶ç½‘å€</a>
<a class="jiathis_button_email">é‚®ä»¶</a>
<a class="jiathis_button_weixin">å¾®ä¿¡</a>
<a class="jiathis_button_qzone">QQç©ºé—´</a>
<a class="jiathis_button_tqq">è…¾è®¯å¾®åš</a>
<a class="jiathis_button_douban">è±†ç“£</a>
<a class="jiathis_button_share">ä¸€é”®åˆ†äº«</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">æ›´å¤š</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOD"></div>
    </div>

  

  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Ãœbersicht
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Ed Sum" />
            
              <p class="site-author-name" itemprop="name">Ed Sum</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç›®å½•"><span class="nav-number">2.</span> <span class="nav-text">ç›®å½•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¬¬ä¸€éƒ¨åˆ†ï¼š-ä»€ä¹ˆæ˜¯é”"><span class="nav-number">2.1.</span> <span class="nav-text">ç¬¬ä¸€éƒ¨åˆ†ï¼š ä»€ä¹ˆæ˜¯é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¬¬äºŒéƒ¨åˆ†ï¼š-é”çš„åˆ†ç±»"><span class="nav-number">2.2.</span> <span class="nav-text">ç¬¬äºŒéƒ¨åˆ†ï¼š é”çš„åˆ†ç±»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼š-æ€§èƒ½å¯¹æ¯”"><span class="nav-number">2.3.</span> <span class="nav-text">ç¬¬ä¸‰éƒ¨åˆ†ï¼š æ€§èƒ½å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¬¬å››éƒ¨åˆ†ï¼š-å¸¸è§çš„æ­»é”"><span class="nav-number">2.4.</span> <span class="nav-text">ç¬¬å››éƒ¨åˆ†ï¼š å¸¸è§çš„æ­»é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¬¬äº”éƒ¨åˆ†ï¼š-æ€»ç»“"><span class="nav-number">2.5.</span> <span class="nav-text">ç¬¬äº”éƒ¨åˆ†ï¼š æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ­£æ–‡"><span class="nav-number">3.</span> <span class="nav-text">æ­£æ–‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸€ã€ä»€ä¹ˆæ˜¯é”"><span class="nav-number">3.1.</span> <span class="nav-text">ä¸€ã€ä»€ä¹ˆæ˜¯é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#äºŒã€é”çš„åˆ†ç±»"><span class="nav-number">3.2.</span> <span class="nav-text">äºŒã€é”çš„åˆ†ç±»</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1ã€äº’æ–¥é”"><span class="nav-number">3.2.1.</span> <span class="nav-text">1ã€äº’æ–¥é”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2ã€é€’å½’é”"><span class="nav-number">3.2.2.</span> <span class="nav-text">2ã€é€’å½’é”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3ã€ä¿¡å·é‡"><span class="nav-number">3.2.3.</span> <span class="nav-text">3ã€ä¿¡å·é‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4ã€æ¡ä»¶é”"><span class="nav-number">3.2.4.</span> <span class="nav-text">4ã€æ¡ä»¶é”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5ã€åˆ†å¸ƒå¼é”"><span class="nav-number">3.2.5.</span> <span class="nav-text">5ã€åˆ†å¸ƒå¼é”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6ã€è¯»å†™é”"><span class="nav-number">3.2.6.</span> <span class="nav-text">6ã€è¯»å†™é”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7ã€è‡ªæ—‹é”"><span class="nav-number">3.2.7.</span> <span class="nav-text">7ã€è‡ªæ—‹é”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8ã€atomic-property-set-get"><span class="nav-number">3.2.8.</span> <span class="nav-text">8ã€atomic(property) set / get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9ã€ONCE"><span class="nav-number">3.2.9.</span> <span class="nav-text">9ã€ONCE</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸‰ã€æ€§èƒ½å¯¹æ¯”"><span class="nav-number">3.3.</span> <span class="nav-text">ä¸‰ã€æ€§èƒ½å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å››ã€å¸¸è§çš„æ­»é”"><span class="nav-number">3.4.</span> <span class="nav-text">å››ã€å¸¸è§çš„æ­»é”</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-ä¸²è¡Œä¸å¹¶è¡Œ"><span class="nav-number">3.4.1.</span> <span class="nav-text">1.ä¸²è¡Œä¸å¹¶è¡Œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-åŒæ­¥ä¸å¼‚æ­¥"><span class="nav-number">3.4.2.</span> <span class="nav-text">2.åŒæ­¥ä¸å¼‚æ­¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-GCD-API"><span class="nav-number">3.4.3.</span> <span class="nav-text">3.GCD API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¡ˆä¾‹åˆ†æ"><span class="nav-number">3.4.4.</span> <span class="nav-text">æ¡ˆä¾‹åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#æ¡ˆä¾‹ä¸€"><span class="nav-number">3.4.4.1.</span> <span class="nav-text">æ¡ˆä¾‹ä¸€</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#æ¡ˆä¾‹äºŒ"><span class="nav-number">3.4.4.2.</span> <span class="nav-text">æ¡ˆä¾‹äºŒ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#æ¡ˆä¾‹ä¸‰"><span class="nav-number">3.4.4.3.</span> <span class="nav-text">æ¡ˆä¾‹ä¸‰</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#æ¡ˆä¾‹å››"><span class="nav-number">3.4.4.4.</span> <span class="nav-text">æ¡ˆä¾‹å››</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#æ¡ˆä¾‹äº”"><span class="nav-number">3.4.4.5.</span> <span class="nav-text">æ¡ˆä¾‹äº”</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#äº”ã€æ€»ç»“"><span class="nav-number">3.5.</span> <span class="nav-text">äº”ã€æ€»ç»“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‚è€ƒæ–‡æ¡£"><span class="nav-number">3.6.</span> <span class="nav-text">å‚è€ƒæ–‡æ¡£</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ed Sum</span>

  
</div>
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
  æœ¬ç«™è®¿å®¢æ•°:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

<!--

  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>

-->


<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">åšå®¢å…¨ç«™å…±7.6kå­—</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  




  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  




  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  
  

  

  

  

  
    <script type="text/javascript" src="/live2d/script.js"></script>
    <canvas id="live2dcanvas" width="150" height="300" class="live2d"></canvas>
    <style>
      #live2dcanvas {
        position: fixed;
        right: 0px;
        z-index: 999;
        pointer-events: none;
        bottom: -20px;
      }
    </style>
    <script>loadlive2d("live2dcanvas" ,"/live2d/assets/haru/haru.model.json",0.5)</script>
  
</body>
</html>
